window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("div#edit-area"),i=document.querySelector("details#instruction-area"),o=document.querySelector("details#environment-area");let a=!1;f.setMobileDevice(),document.documentElement.scroll(0,0),n(),t(),e.addEventListener("input",()=>{t()}),g.addEventListener("click",async()=>{D=!1,await s()}),b.addEventListener("click",async()=>{D=!0,await s()}),v.addEventListener("click",async()=>{$&&window.confirm("Realy kill?")&&(window.clearTimeout(G),U=!0,c())}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(a=!0)}),e.addEventListener("focusout",()=>{a=!1}),window.addEventListener("keyup",e=>{if(a)return;const t=new Event("click");switch(e.key){case"i":i.open=!i.open;break;case"e":o.open=!o.open;break;case"/":const n=document.querySelector(":is(input, textarea, button, select):not(:disabled)");n.matches("details#instruction-area *")&&(i.open=!0),n.matches("details#environment-area *")&&(o.open=!0),n.focus();break;case"r":g.disabled||g.dispatchEvent(t);break;case"s":b.disabled||b.dispatchEvent(t);break;case"k":v.disabled||v.dispatchEvent(t)}}),window.addEventListener("beforeunload",e=>{if(!$)return e.preventDefault(),e.returnValue="",""})}function t(){i()&&(o(),$=!1,a(),r())}function n(){for(const e of E)e.value=M[e.id];for(const e of h)e.value=S[e.id]}function i(){let e=!0;for(const t of E){const n=t.id,i=t.value,o=t.validity;t.setCustomValidity(""),o.valid?T[n]=i:(e=!1,t.setCustomValidity("invalid"),o.badInput?t.setCustomValidity("invalid: badInput"):o.valueMissing?t.setCustomValidity("invalid: valueMissing"):o.tooLong?t.setCustomValidity("invalid: tooLong"):o.tooShort&&t.setCustomValidity("invalid: tooShort"))}for(const t of E)Object.values(T).filter(e=>e===t.value).length>1&&(e=!1,t.setCustomValidity("invalid: unique")),t.reportValidity();const t=/^([1-9][0-9]*|0)$/;for(const n of h){const i=n.id,o=Number(n.value),a=Number(n.min),r=Number(n.max),s=n.validity;n.setCustomValidity(""),s.valid&&t.test(String(o))&&a<=o&&o<=r?N[i]=o:(e=!1,n.setCustomValidity("invalid"),s.badInput?n.setCustomValidity("invalid: badInput"):s.valueMissing?n.setCustomValidity("invalid: valueMissing"):s.rangeOverflow||o>r?n.setCustomValidity("invalid: rangeOverflow"):s.rangeUnderflow||o<a?n.setCustomValidity("invalid: rangeUnderflow"):s.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity()}return e&&(N.PTR_MAX++,N.VAL_MAX++),g.disabled=!e,b.disabled=!e,e}function o(){P=p.value,O=0,V=0,w=[],x=new Uint32Array(N.PTR_MAX).fill(0),k=0,X=0,R=C.value,q=0,I="",$=!0,U=!1,B=0,G=0}function a(){L.emptyChild();for(let e=0;e<P.length;e++){const t=document.createElement("span");t.dataset.index=String(e),t.className="",t.textContent="\n"===P[e]?" \n":P[e],L.appendChild(t)}A.emptyChild();const e=String(N.VAL_MAX-1).replace("-","").length;for(let t=0;t<N.PTR_MAX;t++){const n=document.createElement("span");n.dataset.index=String(t),n.className="",n.textContent=String(x[t]).padStart(e,"0"),A.appendChild(n),A.appendChild(document.createTextNode(" "))}_.textContent=""}function r(){if(!$||D||N.DELAY_MSEC>0){if(V<P.length){const e=L.querySelector(`span[data-index="${V}"]`);e.classList.remove("highlight")}if(O<P.length){const e=L.querySelector(`span[data-index="${O}"]`);e.classList.add("highlight")}V=O;const e=A.querySelector(`span[data-index="${X}"]`);e.classList.remove("highlight");const t=A.querySelector(`span[data-index="${k}"]`);t.classList.add("highlight");const n=String(N.VAL_MAX-1).replace("-","").length;t.textContent=String(x[k]).padStart(n,"0"),X=k}else{const e=L.querySelectorAll("span[data-index]");for(const t of e)t.classList.remove("highlight");const t=String(N.VAL_MAX-1).replace("-","").length;for(let e=0;e<N.PTR_MAX;e++){const n=A.querySelector(`span[data-index="${e}"]`);n.classList.remove("highlight"),e===k&&n.classList.add("highlight"),n.textContent=String(x[e]).padStart(t,"0")}}_.textContent=I}async function s(){l(),await d(),!U&&D&&O<P.length||c()}function l(){$||(o(),a(),r(),y.textContent+="This code was begun.\n",y.scroll(0,y.scrollHeight),f.consoleTime.begin("run time"));for(const e of E)e.disabled=!0;for(const e of h)e.disabled=!0;p.disabled=!0,C.disabled=!0,D||(g.disabled=!0,b.disabled=!0)}async function d(){for(;!U&&O<P.length;){if(N.STEP_MAX!==h[2].max&&B>=N.STEP_MAX){f.errorAlert(`Cannot run more than ${N.STEP_MAX} steps.`),f.errorLog(`Cannot run more than ${N.STEP_MAX} steps.`),y.textContent+=`Cannot run more than ${N.STEP_MAX} steps.\n`,y.scroll(0,y.scrollHeight),U=!0;break}if(u(),O++,U)break;if((D||N.DELAY_MSEC>0)&&r(),await m(N.DELAY_MSEC),D)break}}function c(){r(),$=!1;for(const e of E)e.disabled=!1;for(const e of h)e.disabled=!1;p.disabled=!1,C.disabled=!1,g.disabled=!1,b.disabled=!1,y.textContent+=`run step: ${B}\n`;let e=f.consoleTime.end("run time");y.textContent+=`run time: ${e}ms\n`,y.textContent+=`This code was ${U?"terminated":"finished"}.\n`,y.scroll(0,y.scrollHeight)}function u(){switch(B++,P[O]){case T.PTR_INCREMENT:k++,k+=N.PTR_MAX,k%=N.PTR_MAX;break;case T.PTR_DECREMENT:k--,k+=N.PTR_MAX,k%=N.PTR_MAX;break;case T.VAL_INCREMENT:x[k]++,x[k]+=N.VAL_MAX,x[k]%=N.VAL_MAX;break;case T.VAL_DECREMENT:x[k]--,x[k]+=N.VAL_MAX,x[k]%=N.VAL_MAX;break;case T.VAL_INPUT:q>=R.length?x[k]=0:(x[k]=R.charCodeAt(q)%N.VAL_MAX,q++);break;case T.VAL_OUTPUT:I+=String.fromCharCode(x[k]);break;case T.LOOP_BEGIN:if(w.push(O),0===x[k]){let e=0;for(;O<P.length&&(P[O]===T.LOOP_BEGIN&&e++,P[O]===T.LOOP_END&&e--,0!==e);)O++;if(e>0)return f.errorAlert(`Cannot find "${T.LOOP_END}".`),f.errorLog(`Cannot find "${T.LOOP_END}".`),y.textContent+=`Cannot find "${T.LOOP_END}".\n`,y.scroll(0,y.scrollHeight),void(U=!0);w.pop()}break;case T.LOOP_END:if(0===w.length)return f.errorAlert(`Cannot find "${T.LOOP_BEGIN}".`),f.errorLog(`Cannot find "${T.LOOP_BEGIN}".`),y.textContent+=`Cannot find "${T.LOOP_BEGIN}".\n`,y.scroll(0,y.scrollHeight),void(U=!0);O=w.pop()-1;break;case T.BREAK_POINT:r(),D=!0,g.disabled=!1,b.disabled=!1;break;case T.COMMENT_LINE:for(;"\n"!==P[O]&&(O++,O<P.length););break;default:B--}}function m(e){return new Promise(t=>{!D&&e>0?G=window.setTimeout(()=>{t()},e):t()})}const f=await import("../lib/lib.js"),E=document.querySelectorAll("details#instruction-area input"),h=document.querySelectorAll("details#environment-area input"),p=document.querySelector("textarea#source"),C=document.querySelector("textarea#input"),g=document.querySelector("button#run"),b=document.querySelector("button#step-run"),v=document.querySelector("button#kill"),L=document.querySelector("div#program"),A=document.querySelector("div#memory"),_=document.querySelector("div#output"),y=document.querySelector("div#log"),M=Object.freeze({PTR_INCREMENT:">",PTR_DECREMENT:"<",VAL_INCREMENT:"+",VAL_DECREMENT:"-",VAL_INPUT:",",VAL_OUTPUT:".",LOOP_BEGIN:"[",LOOP_END:"]",BREAK_POINT:"@",COMMENT_LINE:"#"}),S=Object.freeze({PTR_MAX:255,VAL_MAX:255,STEP_MAX:2e4,DELAY_MSEC:1});let T=window.structuredClone(M),N=window.structuredClone(S),P="",O=0,V=0,w=[],x=[],k=0,X=0,R="",q=0,I="",$=!1,D=!1,U=!1,B=0,G=0;e()});