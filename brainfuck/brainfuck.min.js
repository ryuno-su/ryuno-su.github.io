window.addEventListener("DOMContentLoaded",()=>{"use strict";function e(){const e=document.querySelector("div#edit-area"),i=document.querySelector("details#instruction-area"),o=document.querySelector("details#environment-area");let a=!1;setMobileDevice(),document.documentElement.scroll(0,0),window.resizeTo(window.screen.availWidth,window.screen.availHeight),n(),t(),e.addEventListener("input",()=>{t()}),p.addEventListener("click",async()=>{$=!1,await s()}),v.addEventListener("click",async()=>{$=!0,await s()}),C.addEventListener("click",async()=>{I&&window.confirm("Realy kill?")&&(window.clearTimeout(B),D=!0,c())}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(a=!0)}),e.addEventListener("focusout",()=>{a=!1}),window.addEventListener("keyup",e=>{if(a)return;const t=new Event("click");switch(e.key){case"i":i.open=!i.open;break;case"e":o.open=!o.open;break;case"/":const n=document.querySelector(":is(input, textarea, button, select):not(:disabled)");n.matches("details#instruction-area *")&&(i.open=!0),n.matches("details#environment-area *")&&(o.open=!0),n.focus();break;case"r":p.disabled||p.dispatchEvent(t);break;case"s":v.disabled||v.dispatchEvent(t);break;case"k":C.disabled||C.dispatchEvent(t)}}),window.addEventListener("beforeunload",e=>{if(!I)return e.preventDefault(),e.returnValue="",""})}function t(){i()&&(o(),I=!1,a(),r())}function n(){for(const e of f)e.value=y[e.id];for(const e of E)e.value=M[e.id]}function i(){let e=!0;for(const t of f){const n=t.id,i=t.value,o=t.validity;t.setCustomValidity(""),o.valid?S[n]=i:(e=!1,t.setCustomValidity("invalid"),o.badInput?t.setCustomValidity("invalid: badInput"):o.valueMissing?t.setCustomValidity("invalid: valueMissing"):o.tooLong?t.setCustomValidity("invalid: tooLong"):o.tooShort&&t.setCustomValidity("invalid: tooShort"))}for(const t of f)Object.values(S).filter(e=>e===t.value).length>1&&(e=!1,t.setCustomValidity("invalid: unique")),t.reportValidity();const t=/^([1-9][0-9]*|0)$/;for(const n of E){const i=n.id,o=Number(n.value),a=Number(n.min),r=Number(n.max),s=n.validity;n.setCustomValidity(""),s.valid&&t.test(String(o))&&a<=o&&o<=r?T[i]=o:(e=!1,n.setCustomValidity("invalid"),s.badInput?n.setCustomValidity("invalid: badInput"):s.valueMissing?n.setCustomValidity("invalid: valueMissing"):s.rangeOverflow||o>r?n.setCustomValidity("invalid: rangeOverflow"):s.rangeUnderflow||o<a?n.setCustomValidity("invalid: rangeUnderflow"):s.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity()}return e&&(T.PTR_MAX++,T.VAL_MAX++),p.disabled=!e,v.disabled=!e,e}function o(){N=h.value,P=0,w=0,O=[],V=new Uint32Array(T.PTR_MAX).fill(0),x=0,k=0,X=g.value,R=0,q="",I=!0,D=!1,U=0,B=0}function a(){L.emptyChild();for(let e=0;e<N.length;e++){const t=document.createElement("span");t.dataset.index=String(e),t.className="",t.textContent="\n"===N[e]?" \n":N[e],L.appendChild(t)}b.emptyChild();const e=String(T.VAL_MAX-1).replace("-","").length;for(let t=0;t<T.PTR_MAX;t++){const n=document.createElement("span");n.dataset.index=String(t),n.className="",n.textContent=String(V[t]).padStart(e,"0"),b.appendChild(n),b.appendChild(document.createTextNode(" "))}A.textContent=""}function r(){if(!I||$||T.DELAY_MSEC>0){if(w<N.length){const e=L.querySelector(`span[data-index="${w}"]`);e.classList.remove("highlight")}if(P<N.length){const e=L.querySelector(`span[data-index="${P}"]`);e.classList.add("highlight")}w=P;const e=b.querySelector(`span[data-index="${k}"]`);e.classList.remove("highlight");const t=b.querySelector(`span[data-index="${x}"]`);t.classList.add("highlight");const n=String(T.VAL_MAX-1).replace("-","").length;t.textContent=String(V[x]).padStart(n,"0"),k=x}else{const e=L.querySelectorAll("span[data-index]");for(const t of e)t.classList.remove("highlight");const t=String(T.VAL_MAX-1).replace("-","").length;for(let e=0;e<T.PTR_MAX;e++){const n=b.querySelector(`span[data-index="${e}"]`);n.classList.remove("highlight"),e===x&&n.classList.add("highlight"),n.textContent=String(V[e]).padStart(t,"0")}}A.textContent=q}async function s(){d(),await l(),!D&&$&&P<N.length||c()}function d(){I||(o(),a(),r(),_.textContent+="This code was begun.\n",_.scroll(0,_.scrollHeight),consoleTime.begin("run time"));for(const e of f)e.disabled=!0;for(const e of E)e.disabled=!0;h.disabled=!0,g.disabled=!0,$||(p.disabled=!0,v.disabled=!0)}async function l(){for(;!D&&P<N.length;){if(T.STEP_MAX!==E[2].max&&U>=T.STEP_MAX){errorAlert(`Cannot run more than ${T.STEP_MAX} steps.`),errorLog(`Cannot run more than ${T.STEP_MAX} steps.`),_.textContent+=`Cannot run more than ${T.STEP_MAX} steps.\n`,_.scroll(0,_.scrollHeight),D=!0;break}if(u(),P++,D)break;if(($||T.DELAY_MSEC>0)&&r(),await m(T.DELAY_MSEC),$)break}}function c(){r(),I=!1;for(const e of f)e.disabled=!1;for(const e of E)e.disabled=!1;h.disabled=!1,g.disabled=!1,p.disabled=!1,v.disabled=!1,_.textContent+=`run step: ${U}\n`;let e=consoleTime.end("run time");_.textContent+=`run time: ${e}ms\n`,_.textContent+=`This code was ${D?"terminated":"finished"}.\n`,_.scroll(0,_.scrollHeight)}function u(){switch(U++,N[P]){case S.PTR_INCREMENT:x++,x+=T.PTR_MAX,x%=T.PTR_MAX;break;case S.PTR_DECREMENT:x--,x+=T.PTR_MAX,x%=T.PTR_MAX;break;case S.VAL_INCREMENT:V[x]++,V[x]+=T.VAL_MAX,V[x]%=T.VAL_MAX;break;case S.VAL_DECREMENT:V[x]--,V[x]+=T.VAL_MAX,V[x]%=T.VAL_MAX;break;case S.VAL_INPUT:R>=X.length?V[x]=0:(V[x]=X.charCodeAt(R)%T.VAL_MAX,R++);break;case S.VAL_OUTPUT:q+=String.fromCharCode(V[x]);break;case S.LOOP_BEGIN:if(O.push(P),0===V[x]){let e=0;for(;P<N.length&&(N[P]===S.LOOP_BEGIN&&e++,N[P]===S.LOOP_END&&e--,0!==e);)P++;if(e>0)return errorAlert(`Cannot find "${S.LOOP_END}".`),errorLog(`Cannot find "${S.LOOP_END}".`),_.textContent+=`Cannot find "${S.LOOP_END}".\n`,_.scroll(0,_.scrollHeight),void(D=!0);O.pop()}break;case S.LOOP_END:if(0===O.length)return errorAlert(`Cannot find "${S.LOOP_BEGIN}".`),errorLog(`Cannot find "${S.LOOP_BEGIN}".`),_.textContent+=`Cannot find "${S.LOOP_BEGIN}".\n`,_.scroll(0,_.scrollHeight),void(D=!0);P=O.pop()-1;break;case S.BREAK_POINT:r(),$=!0,p.disabled=!1,v.disabled=!1;break;case S.COMMENT_LINE:for(;"\n"!==N[P]&&(P++,P<N.length););break;default:U--}}function m(e){return new Promise(t=>{!$&&e>0?B=window.setTimeout(()=>{t()},e):t()})}const f=document.querySelectorAll("details#instruction-area input"),E=document.querySelectorAll("details#environment-area input"),h=document.querySelector("textarea#source"),g=document.querySelector("textarea#input"),p=document.querySelector("button#run"),v=document.querySelector("button#step-run"),C=document.querySelector("button#kill"),L=document.querySelector("div#program"),b=document.querySelector("div#memory"),A=document.querySelector("div#output"),_=document.querySelector("div#log"),y=Object.freeze({PTR_INCREMENT:">",PTR_DECREMENT:"<",VAL_INCREMENT:"+",VAL_DECREMENT:"-",VAL_INPUT:",",VAL_OUTPUT:".",LOOP_BEGIN:"[",LOOP_END:"]",BREAK_POINT:"@",COMMENT_LINE:"#"}),M=Object.freeze({PTR_MAX:255,VAL_MAX:255,STEP_MAX:2e4,DELAY_MSEC:1});let S=window.structuredClone(y),T=window.structuredClone(M),N="",P=0,w=0,O=[],V=[],x=0,k=0,X="",R=0,q="",I=!1,$=!1,D=!1,U=0,B=0;e()});