window.addEventListener("DOMContentLoaded",()=>{"use strict";function e(){const e=document.querySelector("div#edit-area"),i=document.querySelector("details#instruction-area"),a=document.querySelector("details#environment-area");let o=!1;setMobileDevice(),scroll(0,0),n(),t(),e.addEventListener("input",()=>{t()}),E.addEventListener("click",async()=>{q=!1,await s()}),h.addEventListener("click",async()=>{q=!0,await s()}),p.addEventListener("click",async()=>{0<S&&S<M.length&&!confirm("Realy kill?")||(w=!0,q&&(await s(),q=!1,t()))}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(o=!0)}),e.addEventListener("focusout",()=>{o=!1}),window.addEventListener("keyup",e=>{if(o)return;const t=new Event("click");switch(e.key){case"i":i.open=!i.open;break;case"e":a.open=!a.open;break;case"/":const n=document.querySelector(":is(input, textarea, button, select):not(:disabled)");n.matches("details#instruction-area *")&&(i.open=!0),n.matches("details#environment-area *")&&(a.open=!0),n.focus();break;case"r":E.disabled||E.dispatchEvent(t);break;case"s":h.disabled||h.dispatchEvent(t);break;case"k":p.disabled||p.dispatchEvent(t)}}),window.addEventListener("beforeunload",e=>{if(0<S&&S<M.length)return e.preventDefault(),e.returnValue="",""})}function t(){i()&&(a(),R=!1,o(),r())}function n(){for(const e of c)e.value=A[e.id];for(const e of u)e.value=_[e.id]}function i(){let e=!0;for(const t of c){const n=t.id,i=t.value,a=t.validity;t.setCustomValidity(""),a.valid?b[n]=i:(e=!1,t.setCustomValidity("invalid"),a.badInput?t.setCustomValidity("invalid: badInput"):a.valueMissing?t.setCustomValidity("invalid: valueMissing"):a.tooLong?t.setCustomValidity("invalid: tooLong"):a.tooShort&&t.setCustomValidity("invalid: tooShort"))}for(const t of c)Object.values(b).filter(e=>e===t.value).length>1&&(e=!1,t.setCustomValidity("invalid: unique")),t.reportValidity();const t=/^([1-9][0-9]*|0)$/;for(const n of u){const i=n.id,a=Number(n.value),o=Number(n.min),r=Number(n.max),s=n.validity;n.setCustomValidity(""),s.valid&&t.test(String(a))&&o<=a&&a<=r?y[i]=a:(e=!1,n.setCustomValidity("invalid"),s.badInput?n.setCustomValidity("invalid: badInput"):s.valueMissing?n.setCustomValidity("invalid: valueMissing"):s.rangeOverflow||a>r?n.setCustomValidity("invalid: rangeOverflow"):s.rangeUnderflow||a<o?n.setCustomValidity("invalid: rangeUnderflow"):s.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity()}return e&&(y.PTR_MAX++,y.VAL_MAX++),E.disabled=!e,h.disabled=!e,e}function a(){M=m.value,S=0,T=0,N=[],P=new Uint32Array(y.PTR_MAX).fill(0),O=0,V=0,x=f.value,k=0,X="",R=!0,w=!1,I=0}function o(){C.emptyChild();for(let e=0;e<M.length;e++){const t=document.createElement("span");t.dataset.index=String(e),t.className="",t.textContent="\n"===M[e]?" \n":M[e],C.appendChild(t)}v.emptyChild();const e=String(y.VAL_MAX-1).replace("-","").length;for(let t=0;t<y.PTR_MAX;t++){const n=document.createElement("span");n.dataset.index=String(t),n.className="",n.textContent=String(P[t]).padStart(e,"0"),v.appendChild(n),v.appendChild(document.createTextNode(" "))}L.textContent=""}function r(){if(!R||q||y.DELAY_MSEC>0){if(T<M.length){const e=C.querySelector(`span[data-index="${T}"]`);e.classList.remove("highlight")}if(S<M.length){const e=C.querySelector(`span[data-index="${S}"]`);e.classList.add("highlight")}T=S;const e=v.querySelector(`span[data-index="${V}"]`);e.classList.remove("highlight");const t=v.querySelector(`span[data-index="${O}"]`);t.classList.add("highlight");const n=String(y.VAL_MAX-1).replace("-","").length;t.textContent=String(P[O]).padStart(n,"0"),V=O}else{const e=C.querySelectorAll("span[data-index]");for(const t of e)t.classList.remove("highlight");const t=String(y.VAL_MAX-1).replace("-","").length;for(let e=0;e<y.PTR_MAX;e++){const n=v.querySelector(`span[data-index="${e}"]`);n.classList.remove("highlight"),e===O&&n.classList.add("highlight"),n.textContent=String(P[e]).padStart(t,"0")}}L.textContent=X}async function s(){R||(a(),o(),r(),g.textContent+="This code was begun.\n",consoleTime.begin("run time"));for(const e of c)e.disabled=!0;for(const e of u)e.disabled=!0;for(m.disabled=!0,f.disabled=!0,q||(E.disabled=!0,h.disabled=!0);!w&&S<M.length;){if(y.STEP_MAX!==u[2].max&&I>=y.STEP_MAX){errorAlert(`Cannot run more than ${y.STEP_MAX} steps.`),errorLog(`Cannot run more than ${y.STEP_MAX} steps.`),g.textContent+=`Cannot run more than ${y.STEP_MAX} steps.\n`,w=!0;break}if(d(),S++,w)break;if((q||y.DELAY_MSEC>0)&&r(),await l(y.DELAY_MSEC),q&&S<M.length)return}r(),R=!1;for(const e of c)e.disabled=!1;for(const e of u)e.disabled=!1;m.disabled=!1,f.disabled=!1,E.disabled=!1,h.disabled=!1,g.textContent+=`run step: ${I}\n`;let e=consoleTime.end("run time");g.textContent+=`run time: ${e}ms\n`,g.textContent+=`This code was ${w?"terminated":"finished"}.\n`}function d(){switch(I++,M[S]){case b.PTR_INCREMENT:O++,O+=y.PTR_MAX,O%=y.PTR_MAX;break;case b.PTR_DECREMENT:O--,O+=y.PTR_MAX,O%=y.PTR_MAX;break;case b.VAL_INCREMENT:P[O]++,P[O]+=y.VAL_MAX,P[O]%=y.VAL_MAX;break;case b.VAL_DECREMENT:P[O]--,P[O]+=y.VAL_MAX,P[O]%=y.VAL_MAX;break;case b.VAL_INPUT:k>=x.length?P[O]=0:(P[O]=x.charCodeAt(k)%y.VAL_MAX,k++);break;case b.VAL_OUTPUT:X+=String.fromCharCode(P[O]);break;case b.LOOP_BEGIN:if(N.push(S),0===P[O]){let e=0;for(;S<M.length&&(M[S]===b.LOOP_BEGIN&&e++,M[S]===b.LOOP_END&&e--,0!==e);)S++;if(e>0)return errorAlert(`Cannot find "${b.LOOP_END}".`),errorLog(`Cannot find "${b.LOOP_END}".`),g.textContent+=`Cannot find "${b.LOOP_END}".\n`,void(w=!0);N.pop()}break;case b.LOOP_END:if(0===N.length)return errorAlert(`Cannot find "${b.LOOP_BEGIN}".`),errorLog(`Cannot find "${b.LOOP_BEGIN}".`),g.textContent+=`Cannot find "${b.LOOP_BEGIN}".\n`,void(w=!0);S=N.pop()-1;break;case b.BREAK_POINT:r(),q=!0,E.disabled=!1,h.disabled=!1;break;case b.COMMENT_LINE:for(;"\n"!==M[S]&&(S++,S<M.length););break;default:I--}}function l(e){return new Promise(t=>{!q&&e>0?setTimeout(()=>{t()},e):t()})}const c=document.querySelectorAll("details#instruction-area input"),u=document.querySelectorAll("details#environment-area input"),m=document.querySelector("textarea#source"),f=document.querySelector("textarea#input"),E=document.querySelector("button#run"),h=document.querySelector("button#step-run"),p=document.querySelector("button#kill"),C=document.querySelector("div#program"),v=document.querySelector("div#memory"),L=document.querySelector("div#output"),g=document.querySelector("div#log"),A=Object.freeze({PTR_INCREMENT:">",PTR_DECREMENT:"<",VAL_INCREMENT:"+",VAL_DECREMENT:"-",VAL_INPUT:",",VAL_OUTPUT:".",LOOP_BEGIN:"[",LOOP_END:"]",BREAK_POINT:"@",COMMENT_LINE:"#"}),_=Object.freeze({PTR_MAX:255,VAL_MAX:255,STEP_MAX:2e4,DELAY_MSEC:1});let b=structuredClone(A),y=structuredClone(_),M="",S=0,T=0,N=[],P=[],O=0,V=0,x="",k=0,X="",R=!1,q=!1,w=!1,I=0;e()});