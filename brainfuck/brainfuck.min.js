window.addEventListener("DOMContentLoaded",()=>{"use strict";function e(){const e=document.querySelector("div#edit-area"),i=document.querySelector("details#instruction-area"),a=document.querySelector("details#environment-area");let o=!1;setMobileDevice(),scroll(0,0),n(),t(),e.addEventListener("input",()=>{t()}),E.addEventListener("click",async()=>{q=!1,await s()}),p.addEventListener("click",async()=>{q=!0,await s()}),h.addEventListener("click",async()=>{0<M&&M<C.length&&!confirm("Realy kill?")||(x=!0,q&&(await s(),q=!1,t()))}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(o=!0)}),e.addEventListener("focusout",()=>{o=!1}),window.addEventListener("keyup",e=>{if(o)return;const t=new Event("click");switch(e.key){case"i":i.open=!i.open;break;case"e":a.open=!a.open;break;case"/":const n=document.querySelector(":is(input, textarea, button, select):not(:disabled)");n.matches("details#instruction-area *")&&(i.open=!0),n.matches("details#environment-area *")&&(a.open=!0),n.focus();break;case"r":E.disabled||E.dispatchEvent(t);break;case"s":p.disabled||p.dispatchEvent(t);break;case"k":h.disabled||h.dispatchEvent(t)}}),window.addEventListener("beforeunload",e=>{if(0<M&&M<C.length)return e.preventDefault(),e.returnValue="",""})}function t(){i()&&(a(),X=!1,o(),r())}function n(){for(const e of c)e.value=g[e.id];for(const e of u)e.value=A[e.id]}function i(){let e=!0;for(const t of c){const n=t.id,i=t.value,a=t.validity;t.setCustomValidity(""),a.valid?_[n]=i:(e=!1,t.setCustomValidity("invalid"),a.badInput?t.setCustomValidity("invalid: badInput"):a.valueMissing?t.setCustomValidity("invalid: valueMissing"):a.tooLong?t.setCustomValidity("invalid: tooLong"):a.tooShort&&t.setCustomValidity("invalid: tooShort"))}for(const t of c)Object.values(_).filter(e=>e===t.value).length>1&&(e=!1,t.setCustomValidity("invalid: unique")),t.reportValidity();const t=/^([1-9][0-9]*|0)$/;for(const n of u){const i=n.id,a=Number(n.value),o=Number(n.min),r=Number(n.max),s=n.validity;n.setCustomValidity(""),s.valid&&t.test(String(a))&&o<=a&&a<=r?y[i]=a:(e=!1,n.setCustomValidity("invalid"),s.badInput?n.setCustomValidity("invalid: badInput"):s.valueMissing?n.setCustomValidity("invalid: valueMissing"):s.rangeOverflow||a>r?n.setCustomValidity("invalid: rangeOverflow"):s.rangeUnderflow||a<o?n.setCustomValidity("invalid: rangeUnderflow"):s.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity()}return e&&(y.PTR_MAX++,y.VAL_MAX++),E.disabled=!e,p.disabled=!e,e}function a(){C=m.value,M=0,S=0,T=[],N=new Array(y.PTR_MAX).fill(0),V=0,P=0,O=f.value,k=0,R="",X=!0,x=!1,w=0}function o(){v.emptyChild();for(let e=0;e<C.length;e++){const t=document.createElement("span");t.dataset.index=String(e),t.className="",t.textContent="\n"===C[e]?" \n":C[e],v.appendChild(t)}L.emptyChild();const e=String(y.VAL_MAX-1).replace("-","").length;for(let t=0;t<y.PTR_MAX;t++){const n=document.createElement("span");n.dataset.index=String(t),n.className="",n.textContent=String(N[t]).padStart(e,"0"),L.appendChild(n),L.appendChild(document.createTextNode(" "))}b.textContent=""}function r(){if(!X||q||y.DELAY_MSEC>0){if(S<C.length){const e=v.querySelector(`span[data-index="${S}"]`);e.classList.remove("highlight")}if(M<C.length){const e=v.querySelector(`span[data-index="${M}"]`);e.classList.add("highlight")}S=M;const e=L.querySelector(`span[data-index="${P}"]`);e.classList.remove("highlight");const t=L.querySelector(`span[data-index="${V}"]`);t.classList.add("highlight");const n=String(y.VAL_MAX-1).replace("-","").length;t.textContent=String(N[V]).padStart(n,"0"),P=V}else{const e=v.querySelectorAll("span[data-index]");for(const t of e)t.classList.remove("highlight");const t=String(y.VAL_MAX-1).replace("-","").length;for(let e=0;e<y.PTR_MAX;e++){const n=L.querySelector(`span[data-index="${e}"]`);n.classList.remove("highlight"),e===V&&n.classList.add("highlight"),n.textContent=String(N[e]).padStart(t,"0")}}b.textContent=R}async function s(){X||(a(),o(),r(),consoleTime.begin("run time"));for(const e of c)e.disabled=!0;for(const e of u)e.disabled=!0;for(m.disabled=!0,f.disabled=!0,q||(E.disabled=!0,p.disabled=!0);!x&&M<C.length;){if(w>=y.STEP_MAX){errorAlert(`Cannot run more than ${y.STEP_MAX} steps.`),errorLog(`Cannot run more than ${y.STEP_MAX} steps.`),x=!0;break}if(d(),M++,x)break;if((q||y.DELAY_MSEC>0)&&r(),await l(y.DELAY_MSEC),q&&M<C.length)return}r(),X=!1;for(const e of c)e.disabled=!1;for(const e of u)e.disabled=!1;m.disabled=!1,f.disabled=!1,E.disabled=!1,p.disabled=!1,consoleTime.end("run time")}function d(){switch(w++,C[M]){case _.PTR_INCREMENT:V++,V+=y.PTR_MAX,V%=y.PTR_MAX;break;case _.PTR_DECREMENT:V--,V+=y.PTR_MAX,V%=y.PTR_MAX;break;case _.VAL_INCREMENT:N[V]++,N[V]+=y.VAL_MAX,N[V]%=y.VAL_MAX;break;case _.VAL_DECREMENT:N[V]--,N[V]+=y.VAL_MAX,N[V]%=y.VAL_MAX;break;case _.VAL_INPUT:k>=O.length?N[V]=0:(N[V]=O.charCodeAt(k)%y.VAL_MAX,k++);break;case _.VAL_OUTPUT:R+=String.fromCharCode(N[V]);break;case _.LOOP_BEGIN:if(T.push(M),0===N[V]){let e=0;for(;M<C.length&&(C[M]===_.LOOP_BEGIN&&e++,C[M]===_.LOOP_END&&e--,0!==e);)M++;if(e>0)return errorAlert(`Cannot find "${_.LOOP_END}".`),errorLog(`Cannot find "${_.LOOP_END}".`),void(x=!0);T.pop()}break;case _.LOOP_END:if(0===T.length)return errorAlert(`Cannot find "${_.LOOP_BEGIN}".`),errorLog(`Cannot find "${_.LOOP_BEGIN}".`),void(x=!0);M=T.pop()-1;break;case _.BREAK_POINT:r(),q=!0,E.disabled=!1,p.disabled=!1;break;case _.COMMENT_LINE:for(;"\n"!==C[M]&&(M++,M<C.length););break;default:w--}}function l(e){return new Promise(t=>{!q&&e>0?setTimeout(()=>{t()},e):t()})}const c=document.querySelectorAll("details#instruction-area input"),u=document.querySelectorAll("details#environment-area input"),m=document.querySelector("textarea#source"),f=document.querySelector("textarea#input"),E=document.querySelector("button#run"),p=document.querySelector("button#step-run"),h=document.querySelector("button#kill"),v=document.querySelector("div#program"),L=document.querySelector("div#memory"),b=document.querySelector("div#output"),g=Object.freeze({PTR_INCREMENT:">",PTR_DECREMENT:"<",VAL_INCREMENT:"+",VAL_DECREMENT:"-",VAL_INPUT:",",VAL_OUTPUT:".",LOOP_BEGIN:"[",LOOP_END:"]",BREAK_POINT:"@",COMMENT_LINE:"#"}),A=Object.freeze({PTR_MAX:255,VAL_MAX:255,STEP_MAX:2e4,DELAY_MSEC:1});let _=structuredClone(g),y=structuredClone(A),C="",M=0,S=0,T=[],N=[],V=0,P=0,O="",k=0,R="",X=!1,q=!1,x=!1,w=0;e()});