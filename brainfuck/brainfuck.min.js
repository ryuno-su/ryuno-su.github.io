window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("div#edit-area"),i=document.querySelector("details#instruction-area"),a=document.querySelector("details#environment-area");let o=!1;E.setMobileDevice(),document.documentElement.scroll(0,0),n(),t(),e.addEventListener("input",()=>{t()}),b.addEventListener("click",async()=>{D=!1,await s()}),v.addEventListener("click",async()=>{D=!0,await s()}),g.addEventListener("click",async()=>{$&&window.confirm("Realy kill?")&&(window.clearTimeout(G),U=!0,c())}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(o=!0)}),e.addEventListener("focusout",()=>{o=!1}),window.addEventListener("keyup",e=>{if(o)return;const t=new Event("click");switch(e.key){case"i":i.open=!i.open;break;case"e":a.open=!a.open;break;case"/":const n=document.querySelector(":is(input, textarea, button, select):not(:disabled)");n.matches("details#instruction-area *")&&(i.open=!0),n.matches("details#environment-area *")&&(a.open=!0),n.focus();break;case"r":b.disabled||b.dispatchEvent(t);break;case"s":v.disabled||v.dispatchEvent(t);break;case"k":g.disabled||g.dispatchEvent(t)}}),window.addEventListener("beforeunload",e=>{$||e.preventDefault()})}function t(){i()&&(a(),$=!1,o(),r())}function n(){h.forEach(e=>{e.value=S[e.id]}),f.forEach(e=>{e.value=M[e.id]})}function i(){let e=!0;h.forEach(t=>{const n=t.id,i=t.value,a=t.validity;t.setCustomValidity(""),a.valid?T[n]=i:(e=!1,t.setCustomValidity("invalid"),a.badInput?t.setCustomValidity("invalid: badInput"):a.valueMissing?t.setCustomValidity("invalid: valueMissing"):a.tooLong?t.setCustomValidity("invalid: tooLong"):a.tooShort&&t.setCustomValidity("invalid: tooShort"))}),h.forEach(t=>{Object.values(T).filter(e=>e===t.value).length>1&&(e=!1,t.setCustomValidity("invalid: unique")),t.reportValidity()});const t=/^([1-9][0-9]*|0)$/;return f.forEach(n=>{const i=n.id,a=Number(n.value),o=Number(n.min),r=Number(n.max),s=n.validity;n.setCustomValidity(""),s.valid&&t.test(String(a))&&o<=a&&a<=r?N[i]=a:(e=!1,n.setCustomValidity("invalid"),s.badInput?n.setCustomValidity("invalid: badInput"):s.valueMissing?n.setCustomValidity("invalid: valueMissing"):s.rangeOverflow||a>r?n.setCustomValidity("invalid: rangeOverflow"):s.rangeUnderflow||a<o?n.setCustomValidity("invalid: rangeUnderflow"):s.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity()}),e&&(N.PTR_MAX++,N.VAL_MAX++),b.disabled=!e,v.disabled=!e,e}function a(){O=p.value,P=0,w=0,V=new E.Stack,k=new Uint32Array(N.PTR_MAX).fill(0),x=0,X=0,q=C.value,R=0,I="",$=!0,U=!1,B=0,G=0}function o(){L.emptyChild(),O.forEach((e,t)=>{const n=document.createElement("span");n.dataset.index=String(t),n.className="",n.textContent="\n"===e?" \n":e,L.appendChild(n)}),y.emptyChild();const e=String(N.VAL_MAX-1).replace("-","").length;k.forEach((t,n)=>{const i=document.createElement("span");i.dataset.index=String(n),i.className="",i.textContent=String(t).padStart(e,"0"),y.appendChild(i),y.appendChild(document.createTextNode(" "))}),A.textContent=""}function r(){if(!$||D||N.DELAY_MSEC>0){if(w<O.length){const e=L.querySelector(`span[data-index="${w}"]`);e.classList.remove("highlight")}if(P<O.length){const e=L.querySelector(`span[data-index="${P}"]`);e.classList.add("highlight")}w=P;const e=y.querySelector(`span[data-index="${X}"]`);e.classList.remove("highlight");const t=y.querySelector(`span[data-index="${x}"]`);t.classList.add("highlight");const n=String(N.VAL_MAX-1).replace("-","").length;t.textContent=String(k[x]).padStart(n,"0"),X=x}else{const e=L.querySelectorAll("span[data-index]");for(const t of e)t.classList.remove("highlight");const t=String(N.VAL_MAX-1).replace("-","").length;k.forEach((e,n)=>{const i=y.querySelector(`span[data-index="${n}"]`);i.classList.remove("highlight"),n===x&&i.classList.add("highlight"),i.textContent=String(e).padStart(t,"0")})}A.textContent=I}async function s(){d(),await l(),!U&&D&&P<O.length||c()}function d(){$||(a(),o(),r(),_.textContent+="This code was begun.\n",_.scroll(0,_.scrollHeight),E.consoleTime.begin("run time")),h.forEach(e=>{e.disabled=!0}),f.forEach(e=>{e.disabled=!0}),p.disabled=!0,C.disabled=!0,D||(b.disabled=!0,v.disabled=!0)}async function l(){for(;!U&&P<O.length;){if(N.STEP_MAX!==f[2].max&&B>=N.STEP_MAX){E.errorAlert(`Cannot run more than ${N.STEP_MAX} steps.`),E.errorLog(`Cannot run more than ${N.STEP_MAX} steps.`),_.textContent+=`Cannot run more than ${N.STEP_MAX} steps.\n`,_.scroll(0,_.scrollHeight),U=!0;break}if(u(),P++,U)break;if((D||N.DELAY_MSEC>0)&&r(),await m(N.DELAY_MSEC),D)break}}function c(){r(),$=!1,h.forEach(e=>{e.disabled=!1}),f.forEach(e=>{e.disabled=!1}),p.disabled=!1,C.disabled=!1,b.disabled=!1,v.disabled=!1,_.textContent+=`run step: ${B}\n`;let e=E.consoleTime.end("run time");_.textContent+=`run time: ${e}ms\n`,_.textContent+=`This code was ${U?"terminated":"finished"}.\n`,_.scroll(0,_.scrollHeight)}function u(){switch(B++,O[P]){case T.PTR_INCREMENT:x++,x+=N.PTR_MAX,x%=N.PTR_MAX;break;case T.PTR_DECREMENT:x--,x+=N.PTR_MAX,x%=N.PTR_MAX;break;case T.VAL_INCREMENT:k[x]++,k[x]+=N.VAL_MAX,k[x]%=N.VAL_MAX;break;case T.VAL_DECREMENT:k[x]--,k[x]+=N.VAL_MAX,k[x]%=N.VAL_MAX;break;case T.VAL_INPUT:R>=q.length?k[x]=0:(k[x]=q.charCodeAt(R)%N.VAL_MAX,R++);break;case T.VAL_OUTPUT:I+=String.fromCharCode(k[x]);break;case T.LOOP_BEGIN:if(V.push(P),0===k[x]){let e=0;for(;P<O.length&&(O[P]===T.LOOP_BEGIN&&e++,O[P]===T.LOOP_END&&e--,0!==e);)P++;if(e>0)return E.errorAlert(`Cannot find "${T.LOOP_END}".`),E.errorLog(`Cannot find "${T.LOOP_END}".`),_.textContent+=`Cannot find "${T.LOOP_END}".\n`,_.scroll(0,_.scrollHeight),void(U=!0);V.pop()}break;case T.LOOP_END:if(0===V.size())return E.errorAlert(`Cannot find "${T.LOOP_BEGIN}".`),E.errorLog(`Cannot find "${T.LOOP_BEGIN}".`),_.textContent+=`Cannot find "${T.LOOP_BEGIN}".\n`,_.scroll(0,_.scrollHeight),void(U=!0);P=V.pop()-1;break;case T.BREAK_POINT:r(),D=!0,b.disabled=!1,v.disabled=!1;break;case T.COMMENT_LINE:for(;"\n"!==O[P]&&(P++,P<O.length););break;default:B--}}function m(e){if(!(D||e<=0))return new Promise(t=>{G=window.setTimeout(()=>{t()},e)})}const E=await import("../library/library.min.js"),h=document.querySelectorAll("details#instruction-area input"),f=document.querySelectorAll("details#environment-area input"),p=document.querySelector("textarea#source"),C=document.querySelector("textarea#input"),b=document.querySelector("button#run"),v=document.querySelector("button#step-run"),g=document.querySelector("button#kill"),L=document.querySelector("div#program"),y=document.querySelector("div#memory"),A=document.querySelector("div#output"),_=document.querySelector("div#log"),S=Object.freeze({PTR_INCREMENT:">",PTR_DECREMENT:"<",VAL_INCREMENT:"+",VAL_DECREMENT:"-",VAL_INPUT:",",VAL_OUTPUT:".",LOOP_BEGIN:"[",LOOP_END:"]",BREAK_POINT:"@",COMMENT_LINE:"#"}),M=Object.freeze({PTR_MAX:255,VAL_MAX:255,STEP_MAX:2e4,DELAY_MSEC:1});let T=window.structuredClone(S),N=window.structuredClone(M),O="",P=0,w=0,V=new E.Stack,k=[],x=0,X=0,q="",R=0,I="",$=!1,D=!1,U=!1,B=0,G=0;e()});