window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("div#edit-area"),i=document.querySelector("details#instruction-area"),a=document.querySelector("details#environment-area");let o=!1;document.documentElement.scrollIntoView(),t(),e.addEventListener("input",()=>{n()&&t()}),g.addEventListener("click",async()=>{$=!1,await r()}),v.addEventListener("click",async()=>{$=!0,await r()}),f.addEventListener("click",async()=>{I&&window.confirm("Realy kill?")&&(window.clearTimeout(H),U=!0,l())}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(o=!0)}),e.addEventListener("focusout",()=>{o=!1}),window.addEventListener("keyup",e=>{if(o)return;const t=new Event("click");switch(e.key){case"/":const n=document.querySelector(":is(input, textarea, button, select):not(:disabled)");n.matches("details#instruction-area *")&&(i.open=!0),n.matches("details#environment-area *")&&(a.open=!0),n.focus();break;case"i":i.open=!i.open;break;case"e":a.open=!a.open;break;case"r":g.disabled||g.dispatchEvent(t);break;case"s":v.disabled||v.dispatchEvent(t);break;case"k":f.disabled||f.dispatchEvent(t)}}),window.addEventListener("beforeunload",e=>{I||e.preventDefault()})}function t(){i(),a(),o()}function n(){let e=!0;return E.forEach(t=>{const n=t.id,i=t.value,a=t.validity;t.setCustomValidity(""),a.valid?M[n]=i:(e=!1,t.setCustomValidity("invalid"),a.badInput?t.setCustomValidity("invalid: badInput"):a.valueMissing?t.setCustomValidity("invalid: valueMissing"):a.tooLong?t.setCustomValidity("invalid: tooLong"):a.tooShort&&t.setCustomValidity("invalid: tooShort"))}),E.forEach(t=>{Object.values(M).filter(e=>e===t.value).length>1&&(e=!1,t.setCustomValidity("invalid: unique")),t.reportValidity()}),h.forEach(t=>{const n=t.id,i=t.value,a=Number(t.value),o=Number(t.min),r=Number(t.max),s=new RegExp(t.pattern),d=t.validity;t.setCustomValidity(""),d.valid&&s.test(i)&&o<=a&&a<=r?T[n]=a:(e=!1,t.setCustomValidity("invalid"),d.badInput?t.setCustomValidity("invalid: badInput"):d.valueMissing?t.setCustomValidity("invalid: valueMissing"):d.rangeOverflow||a>r?t.setCustomValidity("invalid: rangeOverflow"):d.rangeUnderflow||a<o?t.setCustomValidity("invalid: rangeUnderflow"):d.stepMismatch&&t.setCustomValidity("invalid: stepMismatch")),t.reportValidity()}),e&&(T.PTR_MAX++,T.VAL_MAX++),g.disabled=!e,v.disabled=!e,e}function i(){w=p.value,V=0,N=0,P=new m.Stack,k=new Uint32Array(T.PTR_MAX).fill(0),x=0,O=0,R=b.value,q=0,X="",I=!0,D=!0,U=!1,B=0,H=0}function a(){y.emptyChild(),w.forEach((e,t)=>{const n=document.createElement("span");n.dataset.index=String(t),n.className="",n.textContent="\n"===e?" \n":e,y.appendChild(n)}),L.emptyChild();const e=String(T.VAL_MAX-1).length;k.forEach((t,n)=>{const i=document.createElement("span");i.dataset.index=String(n),i.className="",i.textContent=String(t).padStart(e,"0"),L.appendChild(i),L.appendChild(document.createTextNode(" "))}),A.textContent=""}function o(){if(!I||$||T.DELAY_MSEC>0){if(N<w.length){const e=y.querySelector(`span[data-index="${N}"]`);e.classList.remove("highlight")}if(V<w.length){const e=y.querySelector(`span[data-index="${V}"]`);e.classList.add("highlight")}N=V;const e=L.querySelector(`span[data-index="${O}"]`);e.classList.remove("highlight");const t=L.querySelector(`span[data-index="${x}"]`);t.classList.add("highlight");const n=String(T.VAL_MAX-1).length;t.textContent=String(k[x]).padStart(n,"0"),O=x}else{const e=y.querySelectorAll("span[data-index]");e.forEach(e=>{e.classList.remove("highlight")});const t=String(T.VAL_MAX-1).length;k.forEach((e,n)=>{const i=L.querySelector(`span[data-index="${n}"]`);i.classList.remove("highlight"),n===x&&i.classList.add("highlight"),i.textContent=String(e).padStart(t,"0")})}A.textContent=X}async function r(){I||t(),D&&(s(),D=!1),await d(),!U&&$&&V<w.length||l()}function s(){const e="This code was begun.";C.textContent+=`${e}\n`,C.scroll(0,C.scrollHeight),m.consoleTime.begin("run time"),E.forEach(e=>{e.disabled=!0}),h.forEach(e=>{e.disabled=!0}),p.disabled=!0,b.disabled=!0,$||(g.disabled=!0,v.disabled=!0)}async function d(){for(;!U&&V<w.length;){if(T.STEP_MAX!==h[2].max&&B>=T.STEP_MAX){const e=`Cannot run more than ${T.STEP_MAX} steps.`;m.errorAlert(e),m.errorLog(e),C.textContent+=`${e}\n`,C.scroll(0,C.scrollHeight),U=!0;break}if(c(),V++,U)break;if(($||T.DELAY_MSEC>0)&&o(),await u(T.DELAY_MSEC),$)break}}function l(){o(),I=!1,E.forEach(e=>{e.disabled=!1}),h.forEach(e=>{e.disabled=!1}),p.disabled=!1,b.disabled=!1,g.disabled=!1,v.disabled=!1;let e=m.consoleTime.end("run time");const t=m.dedent(`\n        run time: ${e}ms\n        run step: ${B}\n        This code was ${U?"terminated":"finished"}.\n    `);C.textContent+=`${t}\n`,C.scroll(0,C.scrollHeight)}function c(){switch(B++,w[V]){case M.PTR_INCREMENT:x++,x+=T.PTR_MAX,x%=T.PTR_MAX;break;case M.PTR_DECREMENT:x--,x+=T.PTR_MAX,x%=T.PTR_MAX;break;case M.VAL_INCREMENT:k[x]++,k[x]+=T.VAL_MAX,k[x]%=T.VAL_MAX;break;case M.VAL_DECREMENT:k[x]--,k[x]+=T.VAL_MAX,k[x]%=T.VAL_MAX;break;case M.VAL_INPUT:q>=R.length?k[x]=0:(k[x]=R.charCodeAt(q)%T.VAL_MAX,q++);break;case M.VAL_OUTPUT:X+=String.fromCharCode(k[x]);break;case M.LOOP_BEGIN:if(P.push(V),0===k[x]){let e=0;for(;V<w.length&&(w[V]===M.LOOP_BEGIN&&e++,w[V]===M.LOOP_END&&e--,0!==e);)V++;if(e>0){const e=`Cannot find "${M.LOOP_END}".`;return m.errorAlert(e),m.errorLog(e),C.textContent+=`${e}\n`,C.scroll(0,C.scrollHeight),void(U=!0)}P.pop()}break;case M.LOOP_END:if(0===P.size()){const e=`Cannot find "${M.LOOP_BEGIN}".`;return m.errorAlert(e),m.errorLog(e),C.textContent+=`${e}\n`,C.scroll(0,C.scrollHeight),void(U=!0)}V=P.pop()-1;break;case M.BREAK_POINT:o(),$=!0,g.disabled=!1,v.disabled=!1;break;case M.COMMENT_LINE:for(;"\n"!==w[V]&&(V++,V<w.length););break;default:B--}}function u(e){if(!($||e<=0))return new Promise(t=>{H=window.setTimeout(()=>{t()},e)})}const m=await import("../library/library.min.js"),E=document.querySelectorAll("details#instruction-area input"),h=document.querySelectorAll("details#environment-area input"),p=document.querySelector("textarea#source"),b=document.querySelector("textarea#input"),g=document.querySelector("button#run"),v=document.querySelector("button#step-run"),f=document.querySelector("button#kill"),y=document.querySelector("div#program"),L=document.querySelector("div#memory"),A=document.querySelector("div#output"),C=document.querySelector("div#log"),_=Object.freeze({PTR_INCREMENT:">",PTR_DECREMENT:"<",VAL_INCREMENT:"+",VAL_DECREMENT:"-",VAL_INPUT:",",VAL_OUTPUT:".",LOOP_BEGIN:"[",LOOP_END:"]",BREAK_POINT:"@",COMMENT_LINE:"#"}),S=Object.freeze({PTR_MAX:255,VAL_MAX:255,STEP_MAX:2e4,DELAY_MSEC:1});let M=window.structuredClone(_),T=window.structuredClone(S),w="",V=0,N=0,P=new m.Stack,k=[],x=0,O=0,R="",q=0,X="",I=!1,$=!1,D=!0,U=!1,B=0,H=0;e()});