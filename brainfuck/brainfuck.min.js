window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("div#edit-area"),i=document.querySelector("details#instruction-area"),a=document.querySelector("details#environment-area");let o=!1;E.setMobileDevice(),document.documentElement.scrollIntoView(),n(),t(),e.addEventListener("input",()=>{t()}),b.addEventListener("click",async()=>{D=!1,await s()}),g.addEventListener("click",async()=>{D=!0,await s()}),y.addEventListener("click",async()=>{$&&window.confirm("Realy kill?")&&(window.clearTimeout(H),U=!0,c())}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(o=!0)}),e.addEventListener("focusout",()=>{o=!1}),window.addEventListener("keyup",e=>{if(o)return;const t=new Event("click");switch(e.key){case"i":i.open=!i.open;break;case"e":a.open=!a.open;break;case"/":const n=document.querySelector(":is(input, textarea, button, select):not(:disabled)");n.matches("details#instruction-area *")&&(i.open=!0),n.matches("details#environment-area *")&&(a.open=!0),n.focus();break;case"r":b.disabled||b.dispatchEvent(t);break;case"s":g.disabled||g.dispatchEvent(t);break;case"k":y.disabled||y.dispatchEvent(t)}}),window.addEventListener("beforeunload",e=>{$||e.preventDefault()})}function t(){i()&&(a(),$=!1,o(),r())}function n(){h.forEach(e=>{e.value=M[e.id]}),p.forEach(e=>{e.value=S[e.id]})}function i(){let e=!0;return h.forEach(t=>{const n=t.id,i=t.value,a=t.validity;t.setCustomValidity(""),a.valid?T[n]=i:(e=!1,t.setCustomValidity("invalid"),a.badInput?t.setCustomValidity("invalid: badInput"):a.valueMissing?t.setCustomValidity("invalid: valueMissing"):a.tooLong?t.setCustomValidity("invalid: tooLong"):a.tooShort&&t.setCustomValidity("invalid: tooShort"))}),h.forEach(t=>{Object.values(T).filter(e=>e===t.value).length>1&&(e=!1,t.setCustomValidity("invalid: unique")),t.reportValidity()}),p.forEach(t=>{const n=t.id,i=t.value,a=Number(t.value),o=Number(t.min),r=Number(t.max),s=new RegExp(t.pattern),d=t.validity;t.setCustomValidity(""),d.valid&&s.test(i)&&o<=a&&a<=r?w[n]=a:(e=!1,t.setCustomValidity("invalid"),d.badInput?t.setCustomValidity("invalid: badInput"):d.valueMissing?t.setCustomValidity("invalid: valueMissing"):d.rangeOverflow||a>r?t.setCustomValidity("invalid: rangeOverflow"):d.rangeUnderflow||a<o?t.setCustomValidity("invalid: rangeUnderflow"):d.stepMismatch&&t.setCustomValidity("invalid: stepMismatch")),t.reportValidity()}),e&&(w.PTR_MAX++,w.VAL_MAX++),b.disabled=!e,g.disabled=!e,e}function a(){V=f.value,N=0,P=0,k=new E.Stack,x=new Uint32Array(w.PTR_MAX).fill(0),O=0,R=0,q=v.value,X=0,I="",$=!0,U=!1,B=0,H=0}function o(){L.emptyChild(),V.forEach((e,t)=>{const n=document.createElement("span");n.dataset.index=String(t),n.className="",n.textContent="\n"===e?" \n":e,L.appendChild(n)}),A.emptyChild();const e=String(w.VAL_MAX-1).replace("-","").length;x.forEach((t,n)=>{const i=document.createElement("span");i.dataset.index=String(n),i.className="",i.textContent=String(t).padStart(e,"0"),A.appendChild(i),A.appendChild(document.createTextNode(" "))}),C.textContent=""}function r(){if(!$||D||w.DELAY_MSEC>0){if(P<V.length){const e=L.querySelector(`span[data-index="${P}"]`);e.classList.remove("highlight")}if(N<V.length){const e=L.querySelector(`span[data-index="${N}"]`);e.classList.add("highlight")}P=N;const e=A.querySelector(`span[data-index="${R}"]`);e.classList.remove("highlight");const t=A.querySelector(`span[data-index="${O}"]`);t.classList.add("highlight");const n=String(w.VAL_MAX-1).replace("-","").length;t.textContent=String(x[O]).padStart(n,"0"),R=O}else{const e=L.querySelectorAll("span[data-index]");e.forEach(e=>{e.classList.remove("highlight")});const t=String(w.VAL_MAX-1).replace("-","").length;x.forEach((e,n)=>{const i=A.querySelector(`span[data-index="${n}"]`);i.classList.remove("highlight"),n===O&&i.classList.add("highlight"),i.textContent=String(e).padStart(t,"0")})}C.textContent=I}async function s(){d(),await l(),!U&&D&&N<V.length||c()}function d(){if(!$){a(),o(),r();const e="This code was begun.";_.textContent+=`${e}\n`,_.scroll(0,_.scrollHeight),E.consoleTime.begin("run time")}h.forEach(e=>{e.disabled=!0}),p.forEach(e=>{e.disabled=!0}),f.disabled=!0,v.disabled=!0,D||(b.disabled=!0,g.disabled=!0)}async function l(){for(;!U&&N<V.length;){if(w.STEP_MAX!==p[2].max&&B>=w.STEP_MAX){const e=`Cannot run more than ${w.STEP_MAX} steps.`;E.errorAlert(e),E.errorLog(e),_.textContent+=`${e}\n`,_.scroll(0,_.scrollHeight),U=!0;break}if(u(),N++,U)break;if((D||w.DELAY_MSEC>0)&&r(),await m(w.DELAY_MSEC),D)break}}function c(){r(),$=!1,h.forEach(e=>{e.disabled=!1}),p.forEach(e=>{e.disabled=!1}),f.disabled=!1,v.disabled=!1,b.disabled=!1,g.disabled=!1;let e=E.consoleTime.end("run time");const t=E.dedent(`\n        run time: ${e}ms\n        run step: ${B}\n        This code was ${U?"terminated":"finished"}.\n    `);_.textContent+=`${t}\n`,_.scroll(0,_.scrollHeight)}function u(){switch(B++,V[N]){case T.PTR_INCREMENT:O++,O+=w.PTR_MAX,O%=w.PTR_MAX;break;case T.PTR_DECREMENT:O--,O+=w.PTR_MAX,O%=w.PTR_MAX;break;case T.VAL_INCREMENT:x[O]++,x[O]+=w.VAL_MAX,x[O]%=w.VAL_MAX;break;case T.VAL_DECREMENT:x[O]--,x[O]+=w.VAL_MAX,x[O]%=w.VAL_MAX;break;case T.VAL_INPUT:X>=q.length?x[O]=0:(x[O]=q.charCodeAt(X)%w.VAL_MAX,X++);break;case T.VAL_OUTPUT:I+=String.fromCharCode(x[O]);break;case T.LOOP_BEGIN:if(k.push(N),0===x[O]){let e=0;for(;N<V.length&&(V[N]===T.LOOP_BEGIN&&e++,V[N]===T.LOOP_END&&e--,0!==e);)N++;if(e>0){const e=`Cannot find "${T.LOOP_END}".`;return E.errorAlert(e),E.errorLog(e),_.textContent+=`${e}\n`,_.scroll(0,_.scrollHeight),void(U=!0)}k.pop()}break;case T.LOOP_END:if(0===k.size()){const e=`Cannot find "${T.LOOP_BEGIN}".`;return E.errorAlert(e),E.errorLog(e),_.textContent+=`${e}\n`,_.scroll(0,_.scrollHeight),void(U=!0)}N=k.pop()-1;break;case T.BREAK_POINT:r(),D=!0,b.disabled=!1,g.disabled=!1;break;case T.COMMENT_LINE:for(;"\n"!==V[N]&&(N++,N<V.length););break;default:B--}}function m(e){if(!(D||e<=0))return new Promise(t=>{H=window.setTimeout(()=>{t()},e)})}const E=await import("../library/library.min.js"),h=document.querySelectorAll("details#instruction-area input"),p=document.querySelectorAll("details#environment-area input"),f=document.querySelector("textarea#source"),v=document.querySelector("textarea#input"),b=document.querySelector("button#run"),g=document.querySelector("button#step-run"),y=document.querySelector("button#kill"),L=document.querySelector("div#program"),A=document.querySelector("div#memory"),C=document.querySelector("div#output"),_=document.querySelector("div#log"),M=Object.freeze({PTR_INCREMENT:">",PTR_DECREMENT:"<",VAL_INCREMENT:"+",VAL_DECREMENT:"-",VAL_INPUT:",",VAL_OUTPUT:".",LOOP_BEGIN:"[",LOOP_END:"]",BREAK_POINT:"@",COMMENT_LINE:"#"}),S=Object.freeze({PTR_MAX:255,VAL_MAX:255,STEP_MAX:2e4,DELAY_MSEC:1});let T=window.structuredClone(M),w=window.structuredClone(S),V="",N=0,P=0,k=new E.Stack,x=[],O=0,R=0,q="",X=0,I="",$=!1,D=!1,U=!1,B=0,H=0;e()});