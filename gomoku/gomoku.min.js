window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("details#parameter-area"),r=document.querySelector("div#board-area"),c=document.querySelector("details#log-area");let d=!1;document.documentElement.scrollIntoView(),n(),e.addEventListener("input",e=>{e.target.focus(),o()&&(n(),le||(le=!0,P.classList.replace("shown","hidden"),Y.disabled=!0,j.disabled=!0))}),k.addEventListener("click",async e=>{e.target.focus(),await a()}),G.addEventListener("click",e=>{e.target.focus(),s(),n(),le=!1,P.classList.replace("hidden","shown"),Y.disabled=!1,j.disabled=!1}),V.addEventListener("click",e=>{e.target.focus(),r.scrollIntoView()}),Y.addEventListener("click",async e=>{e.target.focus(),le||de||await a(),i(ie,!ue)}),j.addEventListener("click",async e=>{e.target.focus(),le||de||await a(),l(ie,!fe)}),z.addEventListener("click",e=>{e.target.focus();const n=de&&!pe;if((!n||window.confirm("Realy reset?"))&&(document.documentElement.scrollIntoView(),le?(P.classList.replace("shown","hidden"),Y.disabled=!0,j.disabled=!0):(P.classList.replace("hidden","shown"),Y.disabled=!1,j.disabled=!1),t(),n)){const e="This game was reset.";F.textContent=e;const t=e;Q.textContent+=`${t}\n`,Q.scroll(0,Q.scrollHeight)}}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(d=!0)}),e.addEventListener("focusout",()=>{d=!1}),window.addEventListener("keyup",t=>{if(d)return;const n=new Event("click");switch(t.key){case"/":const s=document.querySelector(":is(input, textarea, button, select):not(:disabled)"),o=s.parentNode;o.matches("details")&&(o.open=!0),s.focus();break;case"p":e.querySelector("summary").focus(),e.open^=!0;break;case"e":k.disabled||k.dispatchEvent(n);break;case"d":G.disabled||G.dispatchEvent(n);break;case"s":V.dispatchEvent(n);break;case"a":Y.disabled||Y.dispatchEvent(n);break;case"h":j.disabled||j.dispatchEvent(n);break;case"Escape":ue&&i(ie,!1),fe&&l(!1);break;case"r":z.disabled||z.dispatchEvent(n);break;case"l":c.focus(),c.open^=!0}}),window.addEventListener("beforeunload",e=>{const t=de&&!pe;t&&e.preventDefault()})}function t(){window.clearInterval(Ie),F.classList.replace("hidden","shown"),K.classList.replace("shown","hidden"),J.classList.replace("shown","hidden"),n(),W.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!1});const t=document.querySelector("ul#AI_LIST");t.classList.remove("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!1}),k.disabled=!1,G.disabled=!1}function n(){r(),c(),Object.freeze(ae)}function s(){W.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.checked=!1}),X[t].forEach(t=>{e[t-1].checked=!0});const n=W.AI_LEVEL.parentNode;0===X[t].length?n.classList.replace("shown","hidden"):n.classList.replace("hidden","shown")}else{if(e.matches("select")){const n=[...e.options].findIndex(e=>Number(e.value)===X[t]);e=e.options[n],e.selected=!0,e.textContent=String(X[t]),"DELAY_MSEC"===t&&(e.textContent+="ms")}e.value=X[t]}}),Z=window.structuredClone(X),le=!1}function o(){let e=!0;return W.forEach((t,n)=>{const s=t.value,o=Number(t.value),r=t.validity;if("AI_LIST"===n){Z.AI_LIST=[],t.forEach((e,t)=>{const s=e.parentNode;t>=Z.COLOR_NUM?(s.classList.replace("shown","hidden"),e.checked=!1):s.classList.replace("hidden","shown"),e.checked&&Z[n].push(t+1)});const e=W.AI_LEVEL.parentNode;0===Z[n].length?e.classList.replace("shown","hidden"):e.classList.replace("hidden","shown")}else if(t.matches("select"))Z[n]=o;else{let c=Number(t.min),a=Number(t.max),i=new RegExp(t.pattern),l=t.title;c=Z.WIN_LENGTH,l=`${c}以上${a}以下の整数を入力してください`,t.setCustomValidity(""),t.min=String(c),t.max=String(a),t.title=l,r.valid&&i.test(s)&&c<=o&&o<=a?Z[n]=o:(e=!1,t.setCustomValidity("invalid"),r.badInput?t.setCustomValidity("invalid: badInput"):r.valueMissing?t.setCustomValidity("invalid: valueMissing"):r.rangeOverflow||o>a?t.setCustomValidity("invalid: rangeOverflow"):r.rangeUnderflow||o<c?t.setCustomValidity("invalid: rangeUnderflow"):r.stepMismatch&&t.setCustomValidity("invalid: stepMismatch")),t.reportValidity()}}),k.disabled=!e,e}function r(){F.emptyChild(),J.emptyChild(),re=x.createArray2D(Z.BOARD_HEIGHT+2,Z.BOARD_WIDTH+2,te.NONE),ce=window.structuredClone(re),ae=window.structuredClone(re),me=!1,ne=Z.COLOR_NUM,Z.AI_LIST.length===Z.COLOR_NUM&&(me=!0,ne++),ie=te.BLACK;const e=P.querySelector("span.color-text"),t=B[ie].cloneNode(!0);e.replaceWith(t),de=!1,ue=!1,fe=!1,pe=!1,he=!1,Le=!1,Ee="",Ie=0,se=Z.BOARD_WIDTH*Z.BOARD_HEIGHT,oe=0}function c(){const e=document.createElement("thead"),t=document.createElement("tbody");U.emptyChild();for(const n of x.rangeIntAll(0,Z.BOARD_HEIGHT)){const s=document.createElement("tr");for(const e of x.rangeIntAll(0,Z.BOARD_WIDTH)){const t=document.createElement("th");if(0===n){t.textContent=0===e?" ":x.intToAlp(e-1).toUpperCase(),s.appendChild(t);continue}if(0===e){t.textContent=String(n),s.appendChild(t);continue}const o=document.createElement("td"),r=M[re[n][e]].cloneNode(!0);r.dataset.index=String(d(e,n)),r.addEventListener("click",async()=>{if(!le||de)he||Le||pe||(le||de?F.emptyChild():await a(),await u(e,n));else{const e="Please push ENTER or DEFAULT.";F.textContent=e}}),o.appendChild(r),s.appendChild(o),ae[n][e]=r}0!==n?(t.appendChild(s),U.appendChild(t)):(e.appendChild(s),U.appendChild(e))}}async function a(){de=!0,P.classList.replace("hidden","shown"),Y.disabled=!1,j.disabled=!1,W.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!0});const t=document.querySelector("ul#AI_LIST");t.classList.add("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!0}),k.disabled=!0,G.disabled=!0;const e="This game was started.";F.textContent=e;const t=x.dedent(`\n        ${e}\n        COLOR_NUM   : ${Z.COLOR_NUM}\n        WIN_LENGTH  : ${Z.WIN_LENGTH}\n        BOARD_WIDTH : ${Z.BOARD_WIDTH}\n        BOARD_HEIGHT: ${Z.BOARD_HEIGHT}\n        AI_LIST     : ${0===Z.AI_LIST.length?ee[0]:Z.AI_LIST.map(e=>ee[e])}\n        AI_LEVEL    : ${0===Z.AI_LIST.length?ee[0]:Z.AI_LEVEL}\n        DELAY_MSEC  : ${Z.DELAY_MSEC}\n    `);Q.textContent+=`${t}\n`,Q.scroll(0,Q.scrollHeight),await g()}function i(e=ie,t=!0){const n=q[e],s=n.getAttribute("class"),o=R[e],r=o.getAttribute("class");if(t){let e=0,t=[];for(const[n,s]of L()){if(!f(n,s))continue;const o=T(n,s,ie).sum();e<=o&&(e<o&&(t=[]),e=o,t.push([n,s]))}t.forEach(([e,t])=>{const o=ae[t][e],c=(o.getAttribute("class"),M[re[t][e]]),a=c.getAttribute("class");o.classList.contains(s)||(o.classList.replace(a,s),o.classList.replace(r,s),o.dataset.color=n.dataset.color,o.innerHTML=n.innerHTML)})}else for(const[e,t]of L()){const n=ae[t][e],o=(n.getAttribute("class"),M[re[t][e]]),r=o.getAttribute("class");n.classList.contains(s)&&(n.classList.replace(s,r),n.dataset.color=o.dataset.color,n.innerHTML=o.innerHTML)}return ue=t}function l(e=ie,t=!0,n=Z.WIN_LENGTH-2){const s=q[e],o=s.getAttribute("class"),r=R[e],c=r.getAttribute("class"),a=$[e],i=a.getAttribute("class");for(const[s,r]of L()){const l=ae[r][s],d=(l.getAttribute("class"),M[re[r][s]]),u=d.getAttribute("class");if(t){if(re[r][s]!==e)continue;if(!(T(s,r,e).max()>=n))continue;if(l.classList.contains(i))continue;l.classList.replace(u,i),l.classList.replace(o,i),l.classList.replace(c,i),l.dataset.color=a.dataset.color,l.innerHTML=a.innerHTML}else{if(!l.classList.contains(i))continue;l.classList.replace(i,u),l.dataset.color=d.dataset.color,l.innerHTML=d.innerHTML}}return fe=t}function d(e,t,n=Z.BOARD_WIDTH){const s=n+2,o=t*s+e;return o}async function u(e,t){if(!f(e,t,ie,!0))return F.appendChild(document.createTextNode("Cannot put ")),F.appendChild(B[ie].cloneNode(!0)),void F.appendChild(document.createTextNode(" here."));pe=S(e,t),pe||(await A(),await g())}function f(e,t,n=ie,s=!1,o=!0){const r=o?re[t][e]:ce[t][e],c=ae[t][e];if(!h(e,t))return!1;if(r!=te.NONE)return!1;if(s)if(o){E(),I(e,t,n);const s=String(oe+1),o=s.padStart(String(se).length," "),r=ee[n],a=r.padStart(ee.filter((e,t)=>t<=Z.COLOR_NUM).map(e=>e.length).max()," "),i=String(e),l=i.padStart(String(Z.BOARD_WIDTH).length," "),d=String(t),u=d.padStart(String(Z.BOARD_HEIGHT).length," "),f=`${x.intToAlp(e-1).toUpperCase()}${t}`,p=f.padStart(String(Z.BOARD_HEIGHT).length+1," "),h=`step: ${o}, turn: ${a}, x: ${l}, y: ${u}, xy: ${p}, `;Q.textContent+=h,Q.scroll(0,Q.scrollHeight),Ee+=f,m(e,t,n,!0),c.querySelector("rect.highlight-stone")}else ce[t][e]=n;return!0}function p(e=ie){for(const[t,n]of L())if(f(t,n,e))return!0;return!1}function h(e,t,n={}){const{WEST:s=1,EAST:o=Z.BOARD_WIDTH,NORTH:r=1,SOUTH:c=Z.BOARD_HEIGHT}=n,a=s<=e&&e<=o,i=r<=t&&t<=c;return a&&i}function L(e={}){const{WEST:t=1,EAST:n=Z.BOARD_WIDTH,NORTH:s=1,SOUTH:o=Z.BOARD_HEIGHT}=e;return[...x.range2IntAll(s,o,t,n)].map(([e,t])=>[t,e])}function m(e,t,n=ie,s=!0){if(!h(e,t))return!1;const o=ae[t][e],r=(o.getAttribute("class"),M[re[t][e]]),c=r.getAttribute("class"),a=q[n],i=a.getAttribute("class"),l=R[n],d=l.getAttribute("class");if(s){if(o.classList.contains(d))return!1;o.classList.replace(c,d),o.classList.replace(i,d),o.dataset.color=l.dataset.color,o.innerHTML=l.innerHTML}else{if(!o.classList.contains(d))return!1;o.classList.replace(d,c),o.dataset.color=r.dataset.color,o.innerHTML=r.innerHTML}return s}function E(){for(const[e,t]of L())m(e,t,ie,!1)}function I(e,t,n=ie){if(!h(e,t))return;re[t][e]=n;const s=ae[t][e],o=M[n];s.dataset.color=o.dataset.color}async function A(){w(ie)||oe++,ue&&i(ie,!1),fe&&l(ie,!1),ie=b(ie);const e=P.querySelector("span.color-text"),t=B[ie].cloneNode(!0);e.replaceWith(t),w(ie)&&(await A(),await g())}function w(e=ie){return me&&!Z.AI_LIST.includes(e)}function b(e=ie,t=ne){return(e+t)%t+1}function S(e,t){if(!h(e,t))return!1;const n=T(e,t);let s=`len: ${n}`;Q.textContent+=`${s}\n`;const o=e=>e>=Z.WIN_LENGTH;let r=n.some(o),c=!r&&!p(b(ie));if(!r&&!c)return!1;let a="";J.emptyChild(),r&&(a+=`${ee[ie]} won.`,J.appendChild(B[ie].cloneNode(!0)),J.appendChild(document.createTextNode(" won."))),c&&(a+="draw.",J.appendChild(document.createTextNode("draw."))),P.classList.replace("shown","hidden"),F.classList.replace("hidden","shown"),J.classList.replace("hidden","shown"),ue&&i(ie,!1),fe&&l(!1),l(ie,!0,Z.WIN_LENGTH),Y.disabled=!0,j.disabled=!0;const d="This game was over.";return F.textContent=d,s=x.dedent(`\n        result: ${a}\n        record: ${Ee}\n        ${d}\n    `),Q.textContent+=`${s}\n`,Q.scroll(0,Q.scrollHeight),!0}function T(e,t,n=re[t][e],s=!0){const o=Object.freeze([[1,0],[0,1],[1,1],[-1,1]]),r=s?re:ce,c=new Array(o.length).fill(0);if(!h(e,t))return c;if(re[t][e]===te.NONE&&n===te.NONE)return c;const a=r[t][e];r[t][e]=n;for(const[n,[s,a]]of o.entries()){let o=0;for(const n of[-1,1]){const c=Math.trunc((n+1)/2),[i,l]=[n*s,n*a];let[d,u]=[e+c*i,t+c*l];for(;r[t][e]===r[u][d];)d+=i,u+=l,o++}c[n]=o}return r[t][e]=a,c}function _(e=Z.DELAY_MSEC){if(e<=0)return;if(!Le){const t=2;e*=t}const t=K.querySelector("progress#progress"),n=K.querySelector('label[for="progress"]'),s=K.querySelector('output[for="progress"]'),o=Number(t.max);let r=0,c=Math.trunc(100*r/o);n.textContent=Le&&!he?"AI thinking ...":"Please wait ...",t.value=`${r}`,t.textContent=`${c}%`,s.textContent=`${c}%`,K.classList.replace("hidden","shown");const a=e/o,i=4;let l=Math.max(a,i),d=Math.trunc(l/a);return new Promise(e=>{Ie=window.setInterval(()=>{r+=d,c=Math.trunc(100*r/o),t.value=`${r}`,t.textContent=`${c}%`,s.textContent=`${c}%`,r>=Number(t.max)&&(K.classList.replace("shown","hidden"),window.clearInterval(Ie),e())},l)})}async function g(){for(const e of Z.AI_LIST)await C()}async function C(){if(!Z.AI_LIST.includes(ie))return;if(pe)return;Le=!0,Y.disabled=!0,j.disabled=!0,await _(Z.DELAY_MSEC);const[e,t]=y(Z.AI_LEVEL);f(e,t,ie,!0),pe=S(e,t),pe||(F.emptyChild(),Le=!1,Y.disabled=!1,j.disabled=!1,await A())}function y(e){if(0===oe){const e=Math.trunc(Z.BOARD_WIDTH/2),t=Math.trunc(Z.BOARD_HEIGHT/2);return[e,t]}if(x.isBetween(oe,1,Z.COLOR_NUM-1)){let e=[];for(const[t,n]of L())if(!f(t,n))for(const[s,o]of x.range2IntAll(-1,1,-1,1)){if(0===o&&0===s)continue;const[r,c]=[t+o,n+s];f(r,c)&&e.push([r,c])}return e.random()}switch(e){case 0:return H();case 1:return N();case 2:return O();case 3:return v();case 4:return D();default:exit()}}function H(){for(const[e,t]of L())if(f(e,t))return[e,t]}function N(){let e=[];for(const[t,n]of L())f(t,n)&&e.push([t,n]);return e.random()}function O(){let e=1,t=[];for(const[n,s]of L()){if(ce=window.structuredClone(re),!f(n,s,ie,!0,!1))continue;const o=T(n,s,ie,!1).max();e<=o&&(e<o&&(t=[]),e=o,t.push([n,s]))}return t.random()}function v(){let e=Z.WIN_LENGTH+1,t=[];for(const[n,s]of L()){if(ce=window.structuredClone(re),!f(n,s,ie,!0,!1))continue;let o=0;for(const[e,t]of L()){const n=b(ie);if(!f(e,t,n,!1,!1))continue;const s=T(e,t,n,!1).max();o=Math.max(o,s)}e>=o&&(e>o&&(t=[]),e=o,t.push([n,s]))}let n=0,s=[];return ce=window.structuredClone(re),t.forEach(([e,t])=>{const o=T(e,t,ie,!1).max();n<=o&&(n<o&&(s=[]),n=o,s.push([e,t]))}),s.random()}function D(){let e=Z.WIN_LENGTH+1,t=[];for(const[n,s]of L()){if(ce=window.structuredClone(re),!f(n,s,ie,!0,!1))continue;let o=0;for(const[e,t]of L()){const n=b(ie);if(!f(e,t,n,!1,!1))continue;const s=T(e,t,n,!1).max();o=Math.max(o,s)}e>=o&&(e>o&&(t=[]),e=o,t.push([n,s]))}let n=0,s=[];return ce=window.structuredClone(re),t.forEach(([e,t])=>{const o=T(e,t,ie,!1).max();n<=o&&(n<o&&(s=[]),n=o,s.push([e,t]))}),s.random()}const x=await import("../library/library.min.js"),M=document.querySelectorAll("div#template-area > svg.cell"),R=document.querySelectorAll("div#template-area > svg.highlight"),q=document.querySelectorAll("div#template-area > svg.assist"),$=document.querySelectorAll("div#template-area > svg.hint"),B=document.querySelectorAll("div#template-area > span.color-text"),W=Object.freeze({COLOR_NUM:document.querySelector("select#COLOR_NUM"),WIN_LENGTH:document.querySelector("select#WIN_LENGTH"),BOARD_WIDTH:document.querySelector("input#BOARD_WIDTH"),BOARD_HEIGHT:document.querySelector("input#BOARD_HEIGHT"),AI_LIST:document.querySelectorAll("ul#AI_LIST input"),AI_LEVEL:document.querySelector("select#AI_LEVEL"),DELAY_MSEC:document.querySelector("select#DELAY_MSEC")}),k=document.querySelector("button#enter"),G=document.querySelector("button#default"),V=document.querySelector("button#slide"),U=document.querySelector("table#board"),Y=document.querySelector("button#assist"),j=document.querySelector("button#hint"),z=document.querySelector("button#reset"),P=document.querySelector("div#turn"),F=document.querySelector("div#message"),K=document.querySelector("div#wait"),J=document.querySelector("div#result"),Q=document.querySelector("div#log"),X=Object.freeze({COLOR_NUM:2,WIN_LENGTH:5,BOARD_WIDTH:8,BOARD_HEIGHT:8,AI_LIST:[],AI_LEVEL:2,DELAY_MSEC:500});let Z=window.structuredClone(X);const ee=Object.freeze([...B].map(e=>e.textContent.toUpperCase())),te=Object.freeze(x.createEnum(...ee));let ne=0,se=0,oe=0,re=[],ce=[],ae=[],ie=0,le=!1,de=!1,ue=!1,fe=!1,pe=!1,he=!1,Le=!1,me=!1,Ee="",Ie=0;e()});