window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("details#parameter-area"),o=document.querySelector("div#board-area"),c=document.querySelector("details#log-area");let r=!1;M.setMobileDevice(),s(),t(),e.addEventListener("input",()=>{n(),de||(de=!0,pe=!0,Y.disabled=!0,j.disabled=!0)}),B.addEventListener("click",async()=>{await a()}),G.addEventListener("click",()=>{s(),n(),de&&(de=!1,pe=!1,Y.disabled=!1,j.disabled=!1)}),V.addEventListener("click",()=>{o.scrollIntoView()}),Y.addEventListener("click",async()=>{de||(de=!0,await a()),i(ae,!ie)}),j.addEventListener("click",async()=>{de||(de=!0,await a()),l(ae,!le)}),z.addEventListener("click",()=>{const e=B.disabled&&!ue;e&&!window.confirm("Realy reset?")||(t(),e&&(K.textContent="This game was reset.",Q.textContent+="This game was reset.\n",Q.scroll(0,Q.scrollHeight)))}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(r=!0)}),e.addEventListener("focusout",()=>{r=!1}),window.addEventListener("keyup",t=>{if(r)return;const n=new Event("click");switch(t.key){case"/":const s=document.querySelector(":is(input, textarea, button, select):not(:disabled)"),o=s.parentNode;o.matches("details")&&(o.open=!0),s.focus();break;case"p":e.open=!e.open;break;case"e":B.disabled||B.dispatchEvent(n);break;case"d":G.disabled||G.dispatchEvent(n);break;case"s":V.dispatchEvent(n);break;case"a":Y.disabled||Y.dispatchEvent(n);break;case"h":j.disabled||j.dispatchEvent(n);break;case"Escape":ie&&i(ae,!1),le&&l(!1);break;case"r":z.disabled||z.dispatchEvent(n);break;case"l":c.open=!c.open}}),window.addEventListener("beforeunload",e=>{const t=B.disabled&&!ue;t&&e.preventDefault()})}function t(){window.clearInterval(me),P.classList.replace("hidden","shown"),K.classList.replace("hidden","shown"),F.classList.replace("shown","hidden"),J.classList.replace("shown","hidden"),n(),de=!1,pe=!1,document.documentElement.scrollIntoView(),$.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!1});const t=document.querySelector("ul#AI_LIST");t.classList.remove("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!1}),B.disabled=!1}function n(){o()&&(c(),r(),Object.freeze(re))}function s(){$.forEach((e,t)=>{if("AI_LIST"===t)e.forEach(e=>{e.checked=!1}),X.AI_LIST.forEach(t=>{e[t-1].checked=!0});else{if(e.matches("select")){let n=0;switch(t){case"COLOR_NUM":n=0;break;case"WIN_LENGTH":n=2;break;case"AI_LEVEL":n=X[t];break;case"DELAY_MSEC":n=3}e=e.options[n],e.selected=!0,e.textContent=String(X[t]),"DELAY_MSEC"===t&&(e.textContent+="ms")}e.matches('input[type="checkbox"]')&&(e.checked=X[t]),e.value=X[t]}})}function o(){let e=!0;const t=/^([1-9][0-9]*|0)$/;return $.forEach((n,s)=>{const o=Number(n.value),c=n.validity;if("AI_LIST"===s){Z.AI_LIST=[],n.forEach((e,t)=>{const n=e.parentNode;n.classList.replace("hidden","shown"),t>=Z.COLOR_NUM&&(n.classList.replace("shown","hidden"),e.checked=!1),e.checked&&Z.AI_LIST.push(t+1)});const e=$.AI_LEVEL.parentNode;e.classList.replace("hidden","shown"),0===Z.AI_LIST.length&&e.classList.replace("shown","hidden")}else if(n.matches("select"))Z[s]=o;else if(n.matches('input[type="checkbox"]'))Z[s]=n.checked;else{let r=Number(n.min),a=Number(n.max),i=n.title;r=Z.WIN_LENGTH,i=`${r}以上${a}以下の整数を入力してください`,n.setCustomValidity(""),n.min=String(r),n.max=String(a),n.title=i,c.valid&&t.test(String(o))&&r<=o&&o<=a?Z[s]=o:(e=!1,n.setCustomValidity("invalid"),c.badInput?n.setCustomValidity("invalid: badInput"):c.valueMissing?n.setCustomValidity("invalid: valueMissing"):c.rangeOverflow||o>a?n.setCustomValidity("invalid: rangeOverflow"):c.rangeUnderflow||o<r?n.setCustomValidity("invalid: rangeUnderflow"):c.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity()}}),B.disabled=!e,e}function c(){K.emptyChild(),J.emptyChild(),oe=M.createArray2D(Z.BOARD_HEIGHT+2,Z.BOARD_WIDTH+2,te.NONE),ce=window.structuredClone(oe),re=window.structuredClone(oe),he=!1,ne=Z.COLOR_NUM,Z.AI_LIST.length===Z.COLOR_NUM&&(he=!0,ne++),se=0,ae=te.BLACK;const e=P.querySelector("span.color-text"),t=W[ae].cloneNode(!0);e.replaceWith(t),ie=!1,le=!1,ue=!1,fe=!1,Le="",me=0}function r(){const e=document.createElement("thead"),t=document.createElement("tbody");U.emptyChild();for(const n of M.rangeIntAll(0,Z.BOARD_HEIGHT)){const s=document.createElement("tr");for(const e of M.rangeIntAll(0,Z.BOARD_WIDTH)){const t=document.createElement("th");if(0===n){t.textContent=0===e?" ":M.intToAlp(e-1).toUpperCase(),s.appendChild(t);continue}if(0===e){t.textContent=String(n),s.appendChild(t);continue}const o=document.createElement("td"),c=D[oe[n][e]].cloneNode(!0);c.dataset.index=String(d(e,n)),c.addEventListener("click",()=>{u(e,n)}),o.appendChild(c),s.appendChild(o),re[n][e]=c}0!==n?(t.appendChild(s),U.appendChild(t)):(e.appendChild(s),U.appendChild(e))}}async function a(){pe=!1,Y.disabled=!1,j.disabled=!1,$.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!0});const t=document.querySelector("ul#AI_LIST");t.classList.add("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!0}),B.disabled=!0,G.disabled=!0,K.textContent="This game was started.",Q.textContent+="This game was started.\n",Q.textContent+=`WIN_LENGTH: ${Z.WIN_LENGTH}\n`,Q.textContent+=`COLOR_NUM: ${Z.COLOR_NUM}\n`,Q.textContent+=`BOARD_WIDTH: ${Z.BOARD_WIDTH}\n`,Q.textContent+=`BOARD_HEIGHT: ${Z.BOARD_HEIGHT}\n`,Q.textContent+=`AI_LIST: ${0===Z.AI_LIST.length?ee[0]:Z.AI_LIST.map(e=>ee[e])}\n`,Q.textContent+=`AI_LEVEL: ${0===Z.AI_LIST.length?ee[0]:Z.AI_LEVEL}\n`,Q.textContent+=`DELAY_MSEC: ${Z.DELAY_MSEC}\n`,Q.scroll(0,Q.scrollHeight),await S()}function i(e=ae,t=!0){const n=R[e],s=n.getAttribute("class"),o=q[e],c=o.getAttribute("class");if(t){let e=0,t=[];for(const[n,s]of L()){if(!f(n,s))continue;const o=w(n,s,ae).sum();e<=o&&(e<o&&(t=[]),e=o,t.push([n,s]))}t.forEach(([e,t])=>{const o=re[t][e],r=(o.getAttribute("class"),D[oe[t][e]]),a=r.getAttribute("class");o.classList.contains(s)||(o.classList.replace(a,s),o.classList.replace(c,s),o.dataset.color=n.dataset.color,o.innerHTML=n.innerHTML)})}else for(const[e,t]of L()){const n=re[t][e],o=(n.getAttribute("class"),D[oe[t][e]]),c=o.getAttribute("class");n.classList.contains(s)&&(n.classList.replace(s,c),n.dataset.color=o.dataset.color,n.innerHTML=o.innerHTML)}return ie=t}function l(e=ae,t=!0,n=Z.WIN_LENGTH-2){const s=R[e],o=s.getAttribute("class"),c=q[e],r=c.getAttribute("class"),a=k[e],i=a.getAttribute("class");for(const[s,c]of L()){const l=re[c][s],d=(l.getAttribute("class"),D[oe[c][s]]),u=d.getAttribute("class");if(t){if(oe[c][s]!==e)continue;if(!(w(s,c,e).max()>=n))continue;if(l.classList.contains(i))continue;l.classList.replace(u,i),l.classList.replace(o,i),l.classList.replace(r,i),l.dataset.color=a.dataset.color,l.innerHTML=a.innerHTML}else{if(!l.classList.contains(i))continue;l.classList.replace(i,u),l.dataset.color=d.dataset.color,l.innerHTML=d.innerHTML}}return le=t}function d(e,t,n=Z.BOARD_WIDTH){const s=n+2,o=t*s+e;return o}async function u(e,t){if(h(e,t)&&!ue&&!pe&&!fe){if(de||(de=!0,await a()),K.emptyChild(),!f(e,t,ae,!0))return K.appendChild(document.createTextNode("Cannot put ")),K.appendChild(W[ae].cloneNode(!0)),void K.appendChild(document.createTextNode(" here."));ue=T(e,t),ue||(await A(),await S())}}function f(e,t,n=ae,s=!1,o=!0){const c=o?oe[t][e]:ce[t][e],r=re[t][e];if(!h(e,t))return!1;if(c!=te.NONE)return!1;if(s)if(o){E(),I(e,t,n);const s=`${M.intToAlp(e-1).toUpperCase()}${t}`;Q.textContent+=`step: ${se+1}, turn: ${ee[n]}, x: ${e}, y: ${t}, xy: ${s}, `,Q.scroll(0,Q.scrollHeight),Le+=s,m(e,t,n,!0),r.querySelector("rect.highlight-stone")}else ce[t][e]=n;return!0}function p(e=ae){for(const[t,n]of L())if(f(t,n,e))return!0;return!1}function h(e,t,n={}){const{WEST:s=1,EAST:o=Z.BOARD_WIDTH,NORTH:c=1,SOUTH:r=Z.BOARD_HEIGHT}=n,a=s<=e&&e<=o,i=c<=t&&t<=r;return a&&i}function L(e={}){const{WEST:t=1,EAST:n=Z.BOARD_WIDTH,NORTH:s=1,SOUTH:o=Z.BOARD_HEIGHT}=e;return[...M.range2IntAll(s,o,t,n)].map(([e,t])=>[t,e])}function m(e,t,n=ae,s=!0){if(!h(e,t))return!1;const o=re[t][e],c=(o.getAttribute("class"),D[oe[t][e]]),r=c.getAttribute("class"),a=R[n],i=a.getAttribute("class"),l=q[n],d=l.getAttribute("class");if(s){if(o.classList.contains(d))return!1;o.classList.replace(r,d),o.classList.replace(i,d),o.dataset.color=l.dataset.color,o.innerHTML=l.innerHTML}else{if(!o.classList.contains(d))return!1;o.classList.replace(d,r),o.dataset.color=c.dataset.color,o.innerHTML=c.innerHTML}return s}function E(){for(const[e,t]of L())m(e,t,ae,!1)}function I(e,t,n=ae){if(!h(e,t))return;oe[t][e]=n;const s=re[t][e],o=D[n];s.dataset.color=o.dataset.color}async function A(){b(ae)||se++,ie&&i(ae,!1),le&&l(ae,!1),ae=C(ae);const e=P.querySelector("span.color-text"),t=W[ae].cloneNode(!0);e.replaceWith(t),b(ae)&&(await A(),await S())}function b(e=ae){return he&&!Z.AI_LIST.includes(e)}function C(e=ae,t=ne){return(e+t)%t+1}function T(e,t){if(!h(e,t))return!1;const n=w(e,t);Q.textContent+=`len: ${n}\n`;const s=e=>e>=Z.WIN_LENGTH;let o=n.some(s),c=!o&&!p(C(ae));if(!o&&!c)return!1;let r="";return J.emptyChild(),o&&(r+=`${ee[ae]} won.`,J.appendChild(W[ae].cloneNode(!0)),J.appendChild(document.createTextNode(" won."))),c&&(r+="draw.",J.appendChild(document.createTextNode("draw."))),K.textContent="This game was over.",P.classList.replace("shown","hidden"),K.classList.replace("hidden","shown"),J.classList.replace("hidden","shown"),ie&&i(ae,!1),le&&l(!1),l(ae,!0,Z.WIN_LENGTH),Y.disabled=!0,j.disabled=!0,Q.textContent+=`result: ${r}\n`,Q.textContent+=`record: ${Le}\n`,Q.textContent+="This game was over.\n",Q.scroll(0,Q.scrollHeight),!0}function w(e,t,n=oe[t][e],s=!0){const o=Object.freeze([[1,0],[0,1],[1,1],[-1,1]]),c=s?oe:ce,r=new Array(o.length).fill(0);if(!h(e,t))return r;if(oe[t][e]===te.NONE&&n===te.NONE)return r;const a=c[t][e];c[t][e]=n;for(const[n,[s,a]]of o.entries()){let o=0;for(const n of[-1,1]){const r=Math.trunc((n+1)/2),[i,l]=[n*s,n*a];let[d,u]=[e+r*i,t+r*l];for(;c[t][e]===c[u][d];)d+=i,u+=l,o++}r[n]=o}return c[t][e]=a,r}function _(e=Z.DELAY_MSEC){if(e<=0)return;if(!pe){const t=2;e*=t}const t=F.querySelector("progress#progress"),n=F.querySelector('label[for="progress"]'),s=F.querySelector('output[for="progress"]'),o=Number(t.max);let c=0,r=Math.trunc(100*c/o);n.textContent=pe&&!fe?"AI thinking ...":"Please wait ...",t.value=`${c}`,t.textContent=`${r}%`,s.textContent=`${r}%`,F.classList.replace("hidden","shown");const a=e/o,i=4;let l=Math.max(a,i),d=Math.trunc(l/a);return new Promise(e=>{me=window.setInterval(()=>{c+=d,r=Math.trunc(100*c/o),t.value=`${c}`,t.textContent=`${r}%`,s.textContent=`${r}%`,c>=Number(t.max)&&(F.classList.replace("shown","hidden"),window.clearInterval(me),e())},l)})}async function S(){for(const e of Z.AI_LIST)await y()}async function y(){if(!Z.AI_LIST.includes(ae))return;if(ue)return;pe=!0,Y.disabled=!0,j.disabled=!0,await _(Z.DELAY_MSEC);const[e,t]=g(Z.AI_LEVEL);f(e,t,ae,!0),ue=T(e,t),ue||(K.emptyChild(),pe=!1,Y.disabled=!1,j.disabled=!1,await A())}function g(e){if(0===se){const e=Math.trunc(Z.BOARD_WIDTH/2),t=Math.trunc(Z.BOARD_HEIGHT/2);return[e,t]}if(M.isBetween(se,1,Z.COLOR_NUM-1)){let e=[];for(const[t,n]of L())if(!f(t,n))for(const[s,o]of M.range2IntAll(-1,1,-1,1)){if(0===o&&0===s)continue;const[c,r]=[t+o,n+s];f(c,r)&&e.push([c,r])}return e.random()}switch(e){case 0:return H();case 1:return N();case 2:return v();case 3:return O();case 4:return x();default:exit()}}function H(){for(const[e,t]of L())if(f(e,t))return[e,t]}function N(){let e=[];for(const[t,n]of L())f(t,n)&&e.push([t,n]);return e.random()}function v(){let e=1,t=[];for(const[n,s]of L()){if(ce=window.structuredClone(oe),!f(n,s,ae,!0,!1))continue;const o=w(n,s,ae,!1).max();e<=o&&(e<o&&(t=[]),e=o,t.push([n,s]))}return t.random()}function O(){let e=Z.WIN_LENGTH+1,t=[];for(const[n,s]of L()){if(ce=window.structuredClone(oe),!f(n,s,ae,!0,!1))continue;let o=0;for(const[e,t]of L()){const n=C(ae);if(!f(e,t,n,!1,!1))continue;const s=w(e,t,n,!1).max();o=Math.max(o,s)}e>=o&&(e>o&&(t=[]),e=o,t.push([n,s]))}let n=0,s=[];return ce=window.structuredClone(oe),t.forEach(([e,t])=>{const o=w(e,t,ae,!1).max();n<=o&&(n<o&&(s=[]),n=o,s.push([e,t]))}),s.random()}function x(){let e=Z.WIN_LENGTH+1,t=[];for(const[n,s]of L()){if(ce=window.structuredClone(oe),!f(n,s,ae,!0,!1))continue;let o=0;for(const[e,t]of L()){const n=C(ae);if(!f(e,t,n,!1,!1))continue;const s=w(e,t,n,!1).max();o=Math.max(o,s)}e>=o&&(e>o&&(t=[]),e=o,t.push([n,s]))}let n=0,s=[];return ce=window.structuredClone(oe),t.forEach(([e,t])=>{const o=w(e,t,ae,!1).max();n<=o&&(n<o&&(s=[]),n=o,s.push([e,t]))}),s.random()}const M=await import("../library/library.min.js"),D=document.querySelectorAll("div#template-area > svg.cell"),q=document.querySelectorAll("div#template-area > svg.highlight"),R=document.querySelectorAll("div#template-area > svg.assist"),k=document.querySelectorAll("div#template-area > svg.hint"),W=document.querySelectorAll("div#template-area > span.color-text"),$=Object.freeze({COLOR_NUM:document.querySelector("select#COLOR_NUM"),WIN_LENGTH:document.querySelector("select#WIN_LENGTH"),BOARD_WIDTH:document.querySelector("input#BOARD_WIDTH"),BOARD_HEIGHT:document.querySelector("input#BOARD_HEIGHT"),AI_LIST:document.querySelectorAll("ul#AI_LIST input"),AI_LEVEL:document.querySelector("select#AI_LEVEL"),DELAY_MSEC:document.querySelector("select#DELAY_MSEC")}),B=document.querySelector("button#enter"),G=document.querySelector("button#default"),V=document.querySelector("button#slide"),U=document.querySelector("table#board"),Y=document.querySelector("button#assist"),j=document.querySelector("button#hint"),z=document.querySelector("button#reset"),P=document.querySelector("div#turn"),K=document.querySelector("div#message"),F=document.querySelector("div#wait"),J=document.querySelector("div#result"),Q=document.querySelector("div#log"),X=Object.freeze({COLOR_NUM:2,WIN_LENGTH:5,BOARD_WIDTH:8,BOARD_HEIGHT:8,AI_LIST:[],AI_LEVEL:2,DELAY_MSEC:500});let Z=window.structuredClone(X);const ee=Object.freeze([...W].map(e=>e.textContent.toUpperCase())),te=Object.freeze(M.createEnum(ee));let ne=0,se=0,oe=[],ce=[],re=[],ae=0,ie=!1,le=!1,de=!1,ue=!1,fe=!1,pe=!1,he=!1,Le="",me=0;e()});