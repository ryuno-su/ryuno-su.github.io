window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("details#parameter-area"),r=document.querySelector("details#log-area");let s=!1;N.setMobileDevice(),o(),t(),e.addEventListener("input",()=>{n(),ee||(ee=!0,oe=!0,R.disabled=!0,q.disabled=!0)}),D.addEventListener("click",async()=>{await a()}),R.addEventListener("click",async()=>{ee||(ee=!0,await a()),i(Q,!X)}),q.addEventListener("click",async()=>{ee||(ee=!0,await a()),l(!Z)}),k.addEventListener("click",()=>{const e=D.disabled&&!te;e&&!window.confirm("Realy reset?")||(t(),e&&(W.textContent="This game was reset.",U.textContent+="This game was reset.\n",U.scroll(0,U.scrollHeight)))}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(s=!0)}),e.addEventListener("focusout",()=>{s=!1}),window.addEventListener("keyup",t=>{if(s)return;const n=new Event("click");switch(t.key){case"e":D.disabled||D.dispatchEvent(n);break;case"r":k.disabled||k.dispatchEvent(n);break;case"p":e.open=!e.open;break;case"l":r.open=!r.open;break;case"/":const o=document.querySelector(":is(input, textarea, button, select):not(:disabled)"),s=o.parentNode;s.matches("details")&&(s.open=!0),o.focus();break;case"a":R.disabled||R.dispatchEvent(n);break;case"h":q.disabled||q.dispatchEvent(n);break;case"Escape":X&&i(Q,!1),Z&&l(!1)}}),window.addEventListener("beforeunload",e=>{if(D.disabled&&!te)return e.preventDefault(),e.returnValue="",""})}function t(){window.clearInterval(ce),$.classList.replace("hidden","shown"),W.classList.replace("hidden","shown"),B.classList.replace("shown","hidden"),G.classList.replace("shown","hidden"),n(),ee=!1,oe=!1,document.documentElement.scroll(0,0),x.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!1});const t=document.querySelector("ul#AI_LIST");t.classList.remove("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!1}),D.disabled=!1}function n(){r()&&(s(),c(),Object.freeze(J))}function o(){x.forEach((e,t)=>{if("AI_LIST"===t)e.forEach(e=>{e.checked=!1}),V.AI_LIST.forEach(t=>{e[t-1].checked=!0});else{if(e.matches("select")){let n=0;switch(t){case"COLOR_NUM":n=0;break;case"WIN_LENGTH":n=2;break;case"DELAY_MSEC":n=3}e=e.options[n],e.selected=!0,e.textContent=String(V[t]),"DELAY_MSEC"===t&&(e.textContent+="ms")}e.matches('input[type="checkbox"]')&&(e.checked=V[t]),e.value=V[t]}})}function r(){let e=!0;const t=/^([1-9][0-9]*|0)$/;return x.forEach((n,o)=>{const r=Number(n.value),s=n.validity;if("AI_LIST"===o)Y.AI_LIST=[],n.forEach((e,t)=>{const n=e.parentNode;n.classList.replace("hidden","shown"),t>=Y.COLOR_NUM&&(n.classList.replace("shown","hidden"),e.checked=!1),e.checked&&Y.AI_LIST.push(t+1)});else if(n.matches("select"))Y[o]=r;else if(n.matches('input[type="checkbox"]'))Y[o]=n.checked;else{let c=Number(n.min),a=Number(n.max),i=n.title;c=2*Math.trunc(Math.log2(Y.COLOR_NUM-1))+4,i=`${c}以上${a}以下の整数を入力してください`,n.setCustomValidity(""),s.valid&&t.test(String(r))&&c<=r&&r<=a?Y[o]=r:(e=!1,n.setCustomValidity("invalid"),s.badInput?n.setCustomValidity("invalid: badInput"):s.valueMissing?n.setCustomValidity("invalid: valueMissing"):s.rangeOverflow||r>a?n.setCustomValidity("invalid: rangeOverflow"):s.rangeUnderflow||r<c?n.setCustomValidity("invalid: rangeUnderflow"):s.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity(),n.min=String(c),n.max=String(a),n.title=i}}),D.disabled=!e,e}function s(){W.emptyChild(),G.emptyChild(),K=N.createArray2D(Y.BOARD_HEIGHT+2,Y.BOARD_WIDTH+2,z.NONE),F=window.structuredClone(K),J=window.structuredClone(K),re=!1,P=Y.COLOR_NUM,Y.AI_LIST.length===Y.COLOR_NUM&&(re=!0,P++),Q=z.BLACK;const e=$.querySelector("span.color-text"),t=g[Q].cloneNode(!0);e.replaceWith(t),X=!1,Z=!1,te=!1,ne=!1,se="",ce=0}function c(){M.emptyChild();for(const e of N.rangeIntAll(1,Y.BOARD_HEIGHT)){const t=document.createElement("tr");for(const n of N.rangeIntAll(1,Y.BOARD_WIDTH)){const o=document.createElement("td"),r=O[K[e][n]].cloneNode(!0);r.dataset.index=String(d(n,e)),r.addEventListener("click",()=>{u(n,e)}),o.appendChild(r),t.appendChild(o),J[e][n]=r}M.appendChild(t)}}async function a(){oe=!1,R.disabled=!1,q.disabled=!1,x.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!0});const t=document.querySelector("ul#AI_LIST");t.classList.add("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!0}),D.disabled=!0,W.textContent="This game was started.",U.textContent+="This game was started.\n",U.textContent+=`WIN_LENGTH: ${Y.WIN_LENGTH}\n`,U.textContent+=`COLOR_NUM: ${Y.COLOR_NUM}\n`,U.textContent+=`BOARD_WIDTH: ${Y.BOARD_WIDTH}\n`,U.textContent+=`BOARD_HEIGHT: ${Y.BOARD_HEIGHT}\n`,U.textContent+=`AI_LIST: ${0===Y.AI_LIST.length?j[0]:Y.AI_LIST.map(e=>j[e])}\n`,U.textContent+=`DELAY_MSEC: ${Y.DELAY_MSEC}\n`,U.scroll(0,U.scrollHeight),await y()}function i(e=Q,t=!0){const n=H[e].cloneNode(!0),o=n.getAttribute("class");for(const[e,r]of m()){const s=J[r][e];if(t){if(!h(e,r))continue;s.setAttribute("class",o),s.dataset.color=n.dataset.color,s.innerHTML=n.innerHTML}else{const t=O[K[r][e]].cloneNode(!0),n=s.getAttribute("class"),c=t.getAttribute("class");if(n!==o)continue;s.setAttribute("class",c),s.dataset.color=t.dataset.color,s.innerHTML=t.innerHTML}}return X=t}function l(e=!0){return Z=e}function d(e,t,n=Y.BOARD_WIDTH){const o=n+2,r=t*o+e;return r}async function u(e,t){if(!(te||oe||ne)){if(ee||(ee=!0,await a()),W.emptyChild(),!h(e,t,Q,!0))return W.appendChild(document.createTextNode("Cannot put ")),W.appendChild(g[Q].cloneNode(!0)),void W.appendChild(document.createTextNode(" here."));te=S(e,t,Q),te||(await I(),await y())}}function h(e,t,n=Q,o=!1,r=!0){const s=J[t][e];if(!f(e,t))return!1;const c=r?K[t][e]:F[t][e];if(c!=z.NONE)return!1;if(o)if(r){T(),b(e,t,n);const o=`${N.intToAlp(e-1).toUpperCase()}${t}`;U.textContent+=`turn: ${j[n]}, x: ${e}, y: ${t}, xy: ${o}, `,U.scroll(0,U.scrollHeight),se+=o,L(e,t,n,!0),s.querySelector("rect.highlight-stone").classList.add("highlight-put")}else F[t][e]=n;return!0}function p(e=Q){for(const[t,n]of m())if(h(t,n,e))return!0;return!1}function f(e,t,n={}){const{WEST:o=1,EAST:r=Y.BOARD_WIDTH,NORTH:s=1,SOUTH:c=Y.BOARD_HEIGHT}=n,a=o<=e&&e<=r,i=s<=t&&t<=c;return a&&i}function m(e={}){const{WEST:t=1,EAST:n=Y.BOARD_WIDTH,NORTH:o=1,SOUTH:r=Y.BOARD_HEIGHT}=e;return[...N.range2IntAll(o,r,t,n)].map(([e,t])=>[t,e])}function L(e,t,n=Q,o=!0){if(!f(e,t))return;const r=J[t][e],s=O[K[t][e]].cloneNode(!0),c=v[n].cloneNode(!0),a=s.getAttribute("class"),i=c.getAttribute("class");return o?(r.setAttribute("class",i),r.dataset.color=c.dataset.color,r.innerHTML=c.innerHTML):(r.setAttribute("class",a),r.dataset.color=s.dataset.color,r.innerHTML=s.innerHTML),o}function T(){for(const[e,t]of m())L(e,t,Q,!1)}function b(e,t,n=Q){if(!f(e,t))return;K[t][e]=n;const o=J[t][e],r=O[n].cloneNode(!0);o.dataset.color=r.dataset.color,o.innerHTML=r.innerHTML}async function I(){X&&i(Q,!1),Z&&l(!1),Q=A(Q);const e=$.querySelector("span.color-text"),t=g[Q].cloneNode(!0);e.replaceWith(t),C(Q)&&(await I(),await y())}function C(e=Q){return re&&!Y.AI_LIST.includes(e)}function A(e=Q,t=P){return(e+t)%t+1}function S(e,t,n=Q){const o=Object.freeze([[1,0],[0,1],[1,1],[-1,1]]);let r=!1;const s=[];for(const[n,[c,a]]of o.entries()){let n=1;for(const o of[1,-1]){const[r,s]=[o*c,o*a];let[i,l]=[e+r,t+s];for(;K[t][e]===K[l][i];)i+=r,l+=s,n++}s.push(n),n>=Y.WIN_LENGTH&&(r=!0)}U.textContent+=`len: ${s}\n`;let c=!r&&!p(A(n));if(!r&&!c)return!1;let a="";return G.emptyChild(),r&&(a+=`${j[n]} won.`,G.appendChild(g[n].cloneNode(!0)),G.appendChild(document.createTextNode(" won."))),c&&(a+="draw.",G.appendChild(document.createTextNode("draw."))),W.textContent="This game was over.",$.classList.replace("shown","hidden"),W.classList.replace("hidden","shown"),G.classList.replace("hidden","shown"),T(),i(Q,!1),l(!1),R.disabled=!0,q.disabled=!0,U.textContent+=`result: ${a}\n`,U.textContent+=`record: ${se}\n`,U.textContent+="This game was over.\n",U.scroll(0,U.scrollHeight),!0}function E(e){if(e<=0)return new Promise(e=>{e()});if(!oe){const t=2;e*=t}const t=B.querySelector("progress#progress"),n=B.querySelector('label[for="progress"]'),o=B.querySelector('output[for="progress"]');let r=0;n.textContent=oe&&!ne?"AI thinking ...":"Please wait ...",t.value=`${r}`,t.textContent=`${r}%`,o.textContent=`${r}%`,B.classList.replace("hidden","shown");let s=Math.max(e/Number(t.max),4),c=Math.trunc(Number(t.max)/(e/s));return new Promise(e=>{ce=window.setInterval(()=>{r+=c,t.value=`${r}`,t.textContent=`${r}%`,o.textContent=`${r}%`,r>=Number(t.max)&&(B.classList.replace("shown","hidden"),window.clearInterval(ce),e())},s)})}async function y(){for(const e of Y.AI_LIST)await w()}async function w(){if(!Y.AI_LIST.includes(Q))return;if(te)return;oe=!0,R.disabled=!0,q.disabled=!0,await E(Y.DELAY_MSEC);const[e,t]=_();h(e,t,Q,!0),te=S(e,t,Q),te||(W.emptyChild(),oe=!1,R.disabled=!1,q.disabled=!1,await I())}function _(){let e=[];for(const[t,n]of m())h(t,n)&&e.push([t,n]);return e.random()}const N=await import("../lib/lib.min.js"),O=document.querySelectorAll("div#template-area > svg.cell"),v=document.querySelectorAll("div#template-area > svg.highlight"),H=document.querySelectorAll("div#template-area > svg.assist"),g=document.querySelectorAll("div#template-area > span.color-text"),x=Object.freeze({COLOR_NUM:document.querySelector("select#COLOR_NUM"),WIN_LENGTH:document.querySelector("select#WIN_LENGTH"),BOARD_WIDTH:document.querySelector("input#BOARD_WIDTH"),BOARD_HEIGHT:document.querySelector("input#BOARD_HEIGHT"),AI_LIST:document.querySelectorAll("ul#AI_LIST input"),DELAY_MSEC:document.querySelector("select#DELAY_MSEC")}),D=document.querySelector("button#enter"),M=document.querySelector("tbody#board"),R=document.querySelector("button#assist"),q=document.querySelector("button#hint"),k=document.querySelector("button#reset"),$=document.querySelector("div#turn"),W=document.querySelector("div#message"),B=document.querySelector("div#wait"),G=document.querySelector("div#result"),U=document.querySelector("div#log"),V=Object.freeze({COLOR_NUM:2,WIN_LENGTH:5,BOARD_WIDTH:8,BOARD_HEIGHT:8,AI_LIST:[],DELAY_MSEC:500});let Y=window.structuredClone(V);const j=Object.freeze([...g].map(e=>e.textContent.toUpperCase())),z=Object.freeze(N.createEnum(...j));let P=0,K=[],F=[],J=[],Q=0,X=!1,Z=!1,ee=!1,te=!1,ne=!1,oe=!1,re=!1,se="",ce=0;e()});