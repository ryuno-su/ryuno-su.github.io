window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("details#parameter-area"),c=document.querySelector("details#log-area");let s=!1;M.setMobileDevice(),o(),t(),e.addEventListener("input",()=>{n(),le||(le=!0,fe=!0,U.disabled=!0,V.disabled=!0)}),B.addEventListener("click",async()=>{await a()}),U.addEventListener("click",async()=>{le||(le=!0,await a()),i(re,!ae)}),V.addEventListener("click",async()=>{le||(le=!0,await a()),l(re,!ie)}),Y.addEventListener("click",()=>{const e=B.disabled&&!de;e&&!window.confirm("Realy reset?")||(t(),e&&(z.textContent="This game was reset.",F.textContent+="This game was reset.\n",F.scroll(0,F.scrollHeight)))}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(s=!0)}),e.addEventListener("focusout",()=>{s=!1}),window.addEventListener("keyup",t=>{if(s)return;const n=new Event("click");switch(t.key){case"e":B.disabled||B.dispatchEvent(n);break;case"r":Y.disabled||Y.dispatchEvent(n);break;case"p":e.open=!e.open;break;case"l":c.open=!c.open;break;case"/":const o=document.querySelector(":is(input, textarea, button, select):not(:disabled)"),s=o.parentNode;s.matches("details")&&(s.open=!0),o.focus();break;case"a":U.disabled||U.dispatchEvent(n);break;case"h":V.disabled||V.dispatchEvent(n);break;case"Escape":ae&&i(re,!1),ie&&l(re,!1)}}),window.addEventListener("beforeunload",e=>{if(B.disabled&&!de)return e.preventDefault(),""})}function t(){window.clearInterval(Le),j.classList.replace("hidden","shown"),z.classList.replace("hidden","shown"),P.classList.replace("shown","hidden"),K.classList.replace("shown","hidden"),n(),le=!1,fe=!1,document.documentElement.scroll(0,0),$.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!1});const t=document.querySelector("ul#AI_LIST");t.classList.remove("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!1}),B.disabled=!1}function n(){c()&&(s(),r(),Object.freeze(se))}function o(){$.forEach((e,t)=>{if("AI_LIST"===t)e.forEach(e=>{e.checked=!1}),J.AI_LIST.forEach(t=>{e[t-1].checked=!0});else{if(e.matches("select")){let n=0;switch(t){case"COLOR_NUM":n=0;break;case"WIN_LENGTH":n=2;break;case"AI_LEVEL":n=J[t];break;case"DELAY_MSEC":n=3}e=e.options[n],e.selected=!0,e.textContent=String(J[t]),"DELAY_MSEC"===t&&(e.textContent+="ms")}e.matches('input[type="checkbox"]')&&(e.checked=J[t]),e.value=J[t]}})}function c(){let e=!0;const t=/^([1-9][0-9]*|0)$/;return $.forEach((n,o)=>{const c=Number(n.value),s=n.validity;if("AI_LIST"===o){Q.AI_LIST=[],n.forEach((e,t)=>{const n=e.parentNode;n.classList.replace("hidden","shown"),t>=Q.COLOR_NUM&&(n.classList.replace("shown","hidden"),e.checked=!1),e.checked&&Q.AI_LIST.push(t+1)});const e=$.AI_LEVEL.parentNode;e.classList.replace("hidden","shown"),0===Q.AI_LIST.length&&e.classList.replace("shown","hidden")}else if(n.matches("select"))Q[o]=c;else if(n.matches('input[type="checkbox"]'))Q[o]=n.checked;else{let r=Number(n.min),a=Number(n.max),i=n.title;r=Q.WIN_LENGTH,i=`${r}以上${a}以下の整数を入力してください`,n.setCustomValidity(""),n.min=String(r),n.max=String(a),n.title=i,s.valid&&t.test(String(c))&&r<=c&&c<=a?Q[o]=c:(e=!1,n.setCustomValidity("invalid"),s.badInput?n.setCustomValidity("invalid: badInput"):s.valueMissing?n.setCustomValidity("invalid: valueMissing"):s.rangeOverflow||c>a?n.setCustomValidity("invalid: rangeOverflow"):s.rangeUnderflow||c<r?n.setCustomValidity("invalid: rangeUnderflow"):s.stepMismatch&&n.setCustomValidity("invalid: stepMismatch")),n.reportValidity()}}),B.disabled=!e,e}function s(){z.emptyChild(),K.emptyChild(),oe=M.createArray2D(Q.BOARD_HEIGHT+2,Q.BOARD_WIDTH+2,Z.NONE),ce=window.structuredClone(oe),se=window.structuredClone(oe),he=!1,ee=Q.COLOR_NUM,Q.AI_LIST.length===Q.COLOR_NUM&&(he=!0,ee++),te=0,re=Z.BLACK;const e=j.querySelector("span.color-text"),t=W[re].cloneNode(!0);e.replaceWith(t),ae=!1,ie=!1,de=!1,ue=!1,pe="",Le=0}function r(){const e=document.createElement("thead"),t=document.createElement("tbody");G.emptyChild();for(const n of M.rangeIntAll(0,Q.BOARD_HEIGHT)){const o=document.createElement("tr");for(const e of M.rangeIntAll(0,Q.BOARD_WIDTH)){const t=document.createElement("th");if(0===n){t.textContent=0===e?" ":M.intToAlp(e-1).toUpperCase(),o.appendChild(t);continue}if(0===e){t.textContent=String(n),o.appendChild(t);continue}const c=document.createElement("td"),s=D[oe[n][e]].cloneNode(!0);s.dataset.index=String(d(e,n)),s.addEventListener("click",()=>{u(e,n)}),c.appendChild(s),o.appendChild(c),se[n][e]=s}0!==n?(t.appendChild(o),G.appendChild(t)):(e.appendChild(o),G.appendChild(e))}}async function a(){fe=!1,U.disabled=!1,V.disabled=!1,$.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!0});const t=document.querySelector("ul#AI_LIST");t.classList.add("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!0}),B.disabled=!0,z.textContent="This game was started.",F.textContent+="This game was started.\n",F.textContent+=`WIN_LENGTH: ${Q.WIN_LENGTH}\n`,F.textContent+=`COLOR_NUM: ${Q.COLOR_NUM}\n`,F.textContent+=`BOARD_WIDTH: ${Q.BOARD_WIDTH}\n`,F.textContent+=`BOARD_HEIGHT: ${Q.BOARD_HEIGHT}\n`,F.textContent+=`AI_LIST: ${0===Q.AI_LIST.length?X[0]:Q.AI_LIST.map(e=>X[e])}\n`,F.textContent+=`AI_LEVEL: ${0===Q.AI_LIST.length?X[0]:Q.AI_LEVEL}\n`,F.textContent+=`DELAY_MSEC: ${Q.DELAY_MSEC}\n`,F.scroll(0,F.scrollHeight),await S()}function i(e=re,t=!0){const n=q[e].cloneNode(!0),o=n.getAttribute("class");if(t){let e=0,t=[];for(const[n,o]of L()){if(!f(n,o))continue;const c=w(n,o,re).sum();e<=c&&(e<c&&(t=[]),e=c,t.push([n,o]))}t.forEach(([e,t])=>{const c=se[t][e],s=(c.getAttribute("class"),D[oe[t][e]].cloneNode(!0)),r=s.getAttribute("class");c.classList.contains(o)||(c.classList.replace(r,o),c.dataset.color=n.dataset.color,c.innerHTML=n.innerHTML)})}else for(const[e,t]of L()){const n=se[t][e],c=(n.getAttribute("class"),D[oe[t][e]].cloneNode(!0)),s=c.getAttribute("class");n.classList.contains(s)||(n.classList.replace(o,s),n.dataset.color=c.dataset.color,n.innerHTML=c.innerHTML)}return ae=t}function l(e=re,t=!0,n=Q.WIN_LENGTH-2){const o=k[e].cloneNode(!0),c=o.getAttribute("class");for(const[s,r]of L()){const a=se[r][s],i=(a.getAttribute("class"),D[oe[r][s]].cloneNode(!0)),l=i.getAttribute("class");if(t){if(oe[r][s]!==e)continue;if(!(w(s,r,e).max()>=n))continue;if(a.classList.contains(c))continue;a.classList.replace(l,c),a.dataset.color=o.dataset.color,a.innerHTML=o.innerHTML}else{if(a.classList.contains(l))continue;a.classList.replace(c,l),a.dataset.color=i.dataset.color,a.innerHTML=i.innerHTML}}return ie=t}function d(e,t,n=Q.BOARD_WIDTH){const o=n+2,c=t*o+e;return c}async function u(e,t){if(p(e,t)&&!de&&!fe&&!ue){if(le||(le=!0,await a()),z.emptyChild(),!f(e,t,re,!0))return z.appendChild(document.createTextNode("Cannot put ")),z.appendChild(W[re].cloneNode(!0)),void z.appendChild(document.createTextNode(" here."));de=_(e,t),de||(await A(),await S())}}function f(e,t,n=re,o=!1,c=!0){const s=c?oe[t][e]:ce[t][e],r=se[t][e];if(!p(e,t))return!1;if(s!=Z.NONE)return!1;if(o)if(c){E(),i(n,!1),l(n,!1),I(e,t,n);const o=`${M.intToAlp(e-1).toUpperCase()}${t}`;F.textContent+=`step: ${te+1}, turn: ${X[n]}, x: ${e}, y: ${t}, xy: ${o}, `,F.scroll(0,F.scrollHeight),pe+=o,m(e,t,n,!0),r.querySelector("rect.highlight-stone")}else ce[t][e]=n;return!0}function h(e=re){for(const[t,n]of L())if(f(t,n,e))return!0;return!1}function p(e,t,n={}){const{WEST:o=1,EAST:c=Q.BOARD_WIDTH,NORTH:s=1,SOUTH:r=Q.BOARD_HEIGHT}=n,a=o<=e&&e<=c,i=s<=t&&t<=r;return a&&i}function L(e={}){const{WEST:t=1,EAST:n=Q.BOARD_WIDTH,NORTH:o=1,SOUTH:c=Q.BOARD_HEIGHT}=e;return[...M.range2IntAll(o,c,t,n)].map(([e,t])=>[t,e])}function m(e,t,n=re,o=!0){if(!p(e,t))return!1;const c=se[t][e],s=(c.getAttribute("class"),D[oe[t][e]].cloneNode(!0)),r=s.getAttribute("class"),a=R[n].cloneNode(!0),i=a.getAttribute("class");if(o){if(c.classList.contains(i))return!1;c.classList.replace(r,i),c.dataset.color=a.dataset.color,c.innerHTML=a.innerHTML}else{if(c.classList.contains(r))return!1;c.classList.replace(i,r),c.dataset.color=s.dataset.color,c.innerHTML=s.innerHTML}return o}function E(){for(const[e,t]of L())m(e,t,re,!1)}function I(e,t,n=re){if(!p(e,t))return;oe[t][e]=n;const o=se[t][e],c=D[n].cloneNode(!0);o.dataset.color=c.dataset.color,o.innerHTML=c.innerHTML}async function A(){T(re)||te++,ae&&i(re,!1),ie&&l(re,!1),re=C(re);const e=j.querySelector("span.color-text"),t=W[re].cloneNode(!0);e.replaceWith(t),T(re)&&(await A(),await S())}function T(e=re){return he&&!Q.AI_LIST.includes(e)}function C(e=re,t=ee){return(e+t)%t+1}function _(e,t){if(!p(e,t))return!1;const n=w(e,t);F.textContent+=`len: ${n}\n`;const o=e=>e>=Q.WIN_LENGTH;let c=n.some(o),s=!c&&!h(C(re));if(!c&&!s)return!1;let r="";return K.emptyChild(),c&&(r+=`${X[re]} won.`,K.appendChild(W[re].cloneNode(!0)),K.appendChild(document.createTextNode(" won."))),s&&(r+="draw.",K.appendChild(document.createTextNode("draw."))),z.textContent="This game was over.",j.classList.replace("shown","hidden"),z.classList.replace("hidden","shown"),K.classList.replace("hidden","shown"),i(re,!1),l(re,!1),l(re,!0,Q.WIN_LENGTH),U.disabled=!0,V.disabled=!0,F.textContent+=`result: ${r}\n`,F.textContent+=`record: ${pe}\n`,F.textContent+="This game was over.\n",F.scroll(0,F.scrollHeight),!0}function w(e,t,n=oe[t][e],o=!0){const c=o?oe:ce,s=new Array(ne.length).fill(0);if(!p(e,t))return s;if(oe[t][e]===Z.NONE&&n===Z.NONE)return s;const r=c[t][e];c[t][e]=n;for(const[n,[o,r]]of ne.entries()){let a=0;for(const n of[-1,1]){const s=Math.trunc((n+1)/2),[i,l]=[n*o,n*r];let[d,u]=[e+s*i,t+s*l];for(;c[t][e]===c[u][d];)d+=i,u+=l,a++}s[n]=a}return c[t][e]=r,s}function b(e=Q.DELAY_MSEC){if(e<=0)return new Promise(e=>{e()});if(!fe){const t=2;e*=t}const t=P.querySelector("progress#progress"),n=P.querySelector('label[for="progress"]'),o=P.querySelector('output[for="progress"]'),c=Number(t.max);let s=0,r=Math.trunc(100*s/c);n.textContent=fe&&!ue?"AI thinking ...":"Please wait ...",t.value=`${s}`,t.textContent=`${r}%`,o.textContent=`${r}%`,P.classList.replace("hidden","shown");const a=e/c,i=4;let l=Math.max(a,i),d=Math.trunc(l/a);return new Promise(e=>{Le=window.setInterval(()=>{s+=d,r=Math.trunc(100*s/c),t.value=`${s}`,t.textContent=`${r}%`,o.textContent=`${r}%`,s>=Number(t.max)&&(P.classList.replace("shown","hidden"),window.clearInterval(Le),e())},l)})}async function S(){for(const e of Q.AI_LIST)await y()}async function y(){if(!Q.AI_LIST.includes(re))return;if(de)return;fe=!0,U.disabled=!0,V.disabled=!0,await b(Q.DELAY_MSEC);const[e,t]=N(Q.AI_LEVEL);f(e,t,re,!0),de=_(e,t),de||(z.emptyChild(),fe=!1,U.disabled=!1,V.disabled=!1,await A())}function N(e){if(0===te){const e=Math.trunc(Q.BOARD_WIDTH/2),t=Math.trunc(Q.BOARD_HEIGHT/2);return[e,t]}if(M.isBetween(te,1,Q.COLOR_NUM-1)){let e=[];for(const[t,n]of L())if(!f(t,n))for(const[o,c]of M.range2IntAll(-1,1,-1,1)){if(0===c&&0===o)continue;const[s,r]=[t+c,n+o];f(s,r)&&e.push([s,r])}return e.random()}switch(e){case 0:return H();case 1:return g();case 2:return O();case 3:return x();case 4:return v();default:exit()}}function H(){for(const[e,t]of L())if(f(e,t))return[e,t]}function g(){let e=[];for(const[t,n]of L())f(t,n)&&e.push([t,n]);return e.random()}function O(){let e=1,t=[];for(const[n,o]of L()){if(ce=window.structuredClone(oe),!f(n,o,re,!0,!1))continue;const c=w(n,o,re,!1).max();e<=c&&(e<c&&(t=[]),e=c,t.push([n,o]))}return t.random()}function x(){let e=Q.WIN_LENGTH+1,t=[];for(const[n,o]of L()){if(ce=window.structuredClone(oe),!f(n,o,re,!0,!1))continue;let c=0;for(const[e,t]of L()){const n=C(re);if(!f(e,t,n,!1,!1))continue;const o=w(e,t,n,!1).max();c=Math.max(c,o)}e>=c&&(e>c&&(t=[]),e=c,t.push([n,o]))}let n=0,o=[];return ce=window.structuredClone(oe),t.forEach(([e,t])=>{const c=w(e,t,re,!1).max();n<=c&&(n<c&&(o=[]),n=c,o.push([e,t]))}),o.random()}function v(){let e=Q.WIN_LENGTH+1,t=[];for(const[n,o]of L()){if(ce=window.structuredClone(oe),!f(n,o,re,!0,!1))continue;let c=0;for(const[e,t]of L()){const n=C(re);if(!f(e,t,n,!1,!1))continue;const o=w(e,t,n,!1).max();c=Math.max(c,o)}e>=c&&(e>c&&(t=[]),e=c,t.push([n,o]))}let n=0,o=[];return ce=window.structuredClone(oe),t.forEach(([e,t])=>{const c=w(e,t,re,!1).max();n<=c&&(n<c&&(o=[]),n=c,o.push([e,t]))}),o.random()}const M=await import("../library/library.min.js"),D=document.querySelectorAll("div#template-area > svg.cell"),R=document.querySelectorAll("div#template-area > svg.highlight"),q=document.querySelectorAll("div#template-area > svg.assist"),k=document.querySelectorAll("div#template-area > svg.hint"),W=document.querySelectorAll("div#template-area > span.color-text"),$=Object.freeze({COLOR_NUM:document.querySelector("select#COLOR_NUM"),WIN_LENGTH:document.querySelector("select#WIN_LENGTH"),BOARD_WIDTH:document.querySelector("input#BOARD_WIDTH"),BOARD_HEIGHT:document.querySelector("input#BOARD_HEIGHT"),AI_LIST:document.querySelectorAll("ul#AI_LIST input"),AI_LEVEL:document.querySelector("select#AI_LEVEL"),DELAY_MSEC:document.querySelector("select#DELAY_MSEC")}),B=document.querySelector("button#enter"),G=document.querySelector("table#board"),U=document.querySelector("button#assist"),V=document.querySelector("button#hint"),Y=document.querySelector("button#reset"),j=document.querySelector("div#turn"),z=document.querySelector("div#message"),P=document.querySelector("div#wait"),K=document.querySelector("div#result"),F=document.querySelector("div#log"),J=Object.freeze({COLOR_NUM:2,WIN_LENGTH:5,BOARD_WIDTH:8,BOARD_HEIGHT:8,AI_LIST:[],AI_LEVEL:2,DELAY_MSEC:500});let Q=window.structuredClone(J);const X=Object.freeze([...W].map(e=>e.textContent.toUpperCase())),Z=Object.freeze(M.createEnum(X));let ee=0,te=0;const ne=Object.freeze([[1,0],[0,1],[1,1],[-1,1]]);let oe=[],ce=[],se=[],re=0,ae=!1,ie=!1,le=!1,de=!1,ue=!1,fe=!1,he=!1,pe="",Le=0;e()});