window.addEventListener("DOMContentLoaded",async()=>{"use strict";function e(){const e=document.querySelector("details#parameter-area"),o=document.querySelector("div#board-area"),r=document.querySelector("details#log-area");let d=!1;document.documentElement.scrollIntoView(),n(),e.addEventListener("input",()=>{c()&&(n(),le||(le=!0,P.classList.replace("shown","hidden"),Y.disabled=!0,j.disabled=!0))}),B.addEventListener("click",async()=>{await a()}),G.addEventListener("click",()=>{s(),n(),le=!1,P.classList.replace("hidden","shown"),Y.disabled=!1,j.disabled=!1}),U.addEventListener("click",()=>{o.scrollIntoView()}),Y.addEventListener("click",async()=>{le||de||await a(),i(ie,!ue)}),j.addEventListener("click",async()=>{le||de||await a(),l(ie,!fe)}),z.addEventListener("click",()=>{const e=B.disabled&&!pe;if((!e||window.confirm("Realy reset?"))&&(document.documentElement.scrollIntoView(),le?(P.classList.replace("shown","hidden"),Y.disabled=!0,j.disabled=!0):(P.classList.replace("hidden","shown"),Y.disabled=!1,j.disabled=!1),t(),e)){const e="This game was reset.";F.textContent=e;const t=e;Q.textContent+=`${t}\n`,Q.scroll(0,Q.scrollHeight)}}),e.addEventListener("focusin",e=>{const t=e.target.matches('input:is([type="text"], [type="number"]), textarea');t&&(d=!0)}),e.addEventListener("focusout",()=>{d=!1}),window.addEventListener("keyup",t=>{if(d)return;const n=new Event("click");switch(t.key){case"/":const s=document.querySelector(":is(input, textarea, button, select):not(:disabled)"),c=s.parentNode;c.matches("details")&&(c.open=!0),s.focus();break;case"p":e.open=!e.open;break;case"e":B.disabled||B.dispatchEvent(n);break;case"d":G.disabled||G.dispatchEvent(n);break;case"s":U.dispatchEvent(n);break;case"a":Y.disabled||Y.dispatchEvent(n);break;case"h":j.disabled||j.dispatchEvent(n);break;case"Escape":ue&&i(ie,!1),fe&&l(!1);break;case"r":z.disabled||z.dispatchEvent(n);break;case"l":r.open=!r.open}}),window.addEventListener("beforeunload",e=>{const t=B.disabled&&!pe;t&&e.preventDefault()})}function t(){window.clearInterval(Ie),F.classList.replace("hidden","shown"),K.classList.replace("shown","hidden"),J.classList.replace("shown","hidden"),n(),W.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!1});const t=document.querySelector("ul#AI_LIST");t.classList.remove("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!1}),B.disabled=!1,G.disabled=!1}function n(){o(),r(),Object.freeze(ae)}function s(){W.forEach((e,t)=>{if("AI_LIST"===t)e.forEach(e=>{e.checked=!1}),X.AI_LIST.forEach(t=>{e[t-1].checked=!0});else{if(e.matches("select")){let n=0;switch(t){case"COLOR_NUM":n=0;break;case"WIN_LENGTH":n=2;break;case"AI_LEVEL":n=X[t];break;case"DELAY_MSEC":n=3}e=e.options[n],e.selected=!0,e.textContent=String(X[t]),"DELAY_MSEC"===t&&(e.textContent+="ms")}e.matches('input[type="checkbox"]')&&(e.checked=X[t]),e.value=X[t]}}),Z=window.structuredClone(X),le=!1}function c(){let e=!0;return W.forEach((t,n)=>{const s=t.value,c=Number(t.value),o=t.validity;if("AI_LIST"===n){Z.AI_LIST=[],t.forEach((e,t)=>{const n=e.parentNode;n.classList.replace("hidden","shown"),t>=Z.COLOR_NUM&&(n.classList.replace("shown","hidden"),e.checked=!1),e.checked&&Z.AI_LIST.push(t+1)});const e=W.AI_LEVEL.parentNode;e.classList.replace("hidden","shown"),0===Z.AI_LIST.length&&e.classList.replace("shown","hidden")}else if(t.matches("select"))Z[n]=c;else if(t.matches('input[type="checkbox"]'))Z[n]=t.checked;else{let r=Number(t.min),a=Number(t.max),i=new RegExp(t.pattern),l=t.title;r=Z.WIN_LENGTH,l=`${r}以上${a}以下の整数を入力してください`,t.setCustomValidity(""),t.min=String(r),t.max=String(a),t.title=l,o.valid&&i.test(s)&&r<=c&&c<=a?Z[n]=c:(e=!1,t.setCustomValidity("invalid"),o.badInput?t.setCustomValidity("invalid: badInput"):o.valueMissing?t.setCustomValidity("invalid: valueMissing"):o.rangeOverflow||c>a?t.setCustomValidity("invalid: rangeOverflow"):o.rangeUnderflow||c<r?t.setCustomValidity("invalid: rangeUnderflow"):o.stepMismatch&&t.setCustomValidity("invalid: stepMismatch")),t.reportValidity()}}),B.disabled=!e,e}function o(){F.emptyChild(),J.emptyChild(),oe=x.createArray2D(Z.BOARD_HEIGHT+2,Z.BOARD_WIDTH+2,te.NONE),re=window.structuredClone(oe),ae=window.structuredClone(oe),me=!1,ne=Z.COLOR_NUM,Z.AI_LIST.length===Z.COLOR_NUM&&(me=!0,ne++),ie=te.BLACK;const e=P.querySelector("span.color-text"),t=k[ie].cloneNode(!0);e.replaceWith(t),de=!1,ue=!1,fe=!1,pe=!1,he=!1,Le=!1,Ee="",Ie=0,se=Z.BOARD_WIDTH*Z.BOARD_HEIGHT,ce=0}function r(){const e=document.createElement("thead"),t=document.createElement("tbody");V.emptyChild();for(const n of x.rangeIntAll(0,Z.BOARD_HEIGHT)){const s=document.createElement("tr");for(const e of x.rangeIntAll(0,Z.BOARD_WIDTH)){const t=document.createElement("th");if(0===n){t.textContent=0===e?" ":x.intToAlp(e-1).toUpperCase(),s.appendChild(t);continue}if(0===e){t.textContent=String(n),s.appendChild(t);continue}const c=document.createElement("td"),o=M[oe[n][e]].cloneNode(!0);o.dataset.index=String(d(e,n)),o.addEventListener("click",async()=>{if(!le||de)he||Le||pe||(le||de?F.emptyChild():await a(),await u(e,n));else{const e="Please push ENTER or DEFAULT.";F.textContent=e}}),c.appendChild(o),s.appendChild(c),ae[n][e]=o}0!==n?(t.appendChild(s),V.appendChild(t)):(e.appendChild(s),V.appendChild(e))}}async function a(){de=!0,P.classList.replace("hidden","shown"),Y.disabled=!1,j.disabled=!1,W.forEach((e,t)=>{if("AI_LIST"===t){e.forEach(e=>{e.disabled=!0});const t=document.querySelector("ul#AI_LIST");t.classList.add("disabled")}else e.matches("option")&&(e=e.parentNode),e.disabled=!0}),B.disabled=!0,G.disabled=!0;const e="This game was started.";F.textContent=e;const t=x.dedent(`\n        ${e}\n        COLOR_NUM   : ${Z.COLOR_NUM}\n        WIN_LENGTH  : ${Z.WIN_LENGTH}\n        BOARD_WIDTH : ${Z.BOARD_WIDTH}\n        BOARD_HEIGHT: ${Z.BOARD_HEIGHT}\n        AI_LIST     : ${0===Z.AI_LIST.length?ee[0]:Z.AI_LIST.map(e=>ee[e])}\n        AI_LEVEL    : ${0===Z.AI_LIST.length?ee[0]:Z.AI_LEVEL}\n        DELAY_MSEC  : ${Z.DELAY_MSEC}\n    `);Q.textContent+=`${t}\n`,Q.scroll(0,Q.scrollHeight),await C()}function i(e=ie,t=!0){const n=q[e],s=n.getAttribute("class"),c=R[e],o=c.getAttribute("class");if(t){let e=0,t=[];for(const[n,s]of L()){if(!f(n,s))continue;const c=w(n,s,ie).sum();e<=c&&(e<c&&(t=[]),e=c,t.push([n,s]))}t.forEach(([e,t])=>{const c=ae[t][e],r=(c.getAttribute("class"),M[oe[t][e]]),a=r.getAttribute("class");c.classList.contains(s)||(c.classList.replace(a,s),c.classList.replace(o,s),c.dataset.color=n.dataset.color,c.innerHTML=n.innerHTML)})}else for(const[e,t]of L()){const n=ae[t][e],c=(n.getAttribute("class"),M[oe[t][e]]),o=c.getAttribute("class");n.classList.contains(s)&&(n.classList.replace(s,o),n.dataset.color=c.dataset.color,n.innerHTML=c.innerHTML)}return ue=t}function l(e=ie,t=!0,n=Z.WIN_LENGTH-2){const s=q[e],c=s.getAttribute("class"),o=R[e],r=o.getAttribute("class"),a=$[e],i=a.getAttribute("class");for(const[s,o]of L()){const l=ae[o][s],d=(l.getAttribute("class"),M[oe[o][s]]),u=d.getAttribute("class");if(t){if(oe[o][s]!==e)continue;if(!(w(s,o,e).max()>=n))continue;if(l.classList.contains(i))continue;l.classList.replace(u,i),l.classList.replace(c,i),l.classList.replace(r,i),l.dataset.color=a.dataset.color,l.innerHTML=a.innerHTML}else{if(!l.classList.contains(i))continue;l.classList.replace(i,u),l.dataset.color=d.dataset.color,l.innerHTML=d.innerHTML}}return fe=t}function d(e,t,n=Z.BOARD_WIDTH){const s=n+2,c=t*s+e;return c}async function u(e,t){if(!f(e,t,ie,!0))return F.appendChild(document.createTextNode("Cannot put ")),F.appendChild(k[ie].cloneNode(!0)),void F.appendChild(document.createTextNode(" here."));pe=S(e,t),pe||(await A(),await C())}function f(e,t,n=ie,s=!1,c=!0){const o=c?oe[t][e]:re[t][e],r=ae[t][e];if(!h(e,t))return!1;if(o!=te.NONE)return!1;if(s)if(c){E(),I(e,t,n);const s=String(ce+1).padStart(String(se).length," "),c=ee[n].padStart(ee.filter((e,t)=>t<=Z.COLOR_NUM).map(e=>e.length).max()," "),o=String(e).padStart(String(Z.BOARD_WIDTH).length," "),a=String(t).padStart(String(Z.BOARD_HEIGHT).length," "),i=`${x.intToAlp(e-1).toUpperCase()}${t}`.padStart(String(Z.BOARD_HEIGHT).length+1," "),l=`step: ${s}, turn: ${c}, x: ${o}, y: ${a}, xy: ${i}, `;Q.textContent+=`${l}`,Q.scroll(0,Q.scrollHeight),Ee+=i,m(e,t,n,!0),r.querySelector("rect.highlight-stone")}else re[t][e]=n;return!0}function p(e=ie){for(const[t,n]of L())if(f(t,n,e))return!0;return!1}function h(e,t,n={}){const{WEST:s=1,EAST:c=Z.BOARD_WIDTH,NORTH:o=1,SOUTH:r=Z.BOARD_HEIGHT}=n,a=s<=e&&e<=c,i=o<=t&&t<=r;return a&&i}function L(e={}){const{WEST:t=1,EAST:n=Z.BOARD_WIDTH,NORTH:s=1,SOUTH:c=Z.BOARD_HEIGHT}=e;return[...x.range2IntAll(s,c,t,n)].map(([e,t])=>[t,e])}function m(e,t,n=ie,s=!0){if(!h(e,t))return!1;const c=ae[t][e],o=(c.getAttribute("class"),M[oe[t][e]]),r=o.getAttribute("class"),a=q[n],i=a.getAttribute("class"),l=R[n],d=l.getAttribute("class");if(s){if(c.classList.contains(d))return!1;c.classList.replace(r,d),c.classList.replace(i,d),c.dataset.color=l.dataset.color,c.innerHTML=l.innerHTML}else{if(!c.classList.contains(d))return!1;c.classList.replace(d,r),c.dataset.color=o.dataset.color,c.innerHTML=o.innerHTML}return s}function E(){for(const[e,t]of L())m(e,t,ie,!1)}function I(e,t,n=ie){if(!h(e,t))return;oe[t][e]=n;const s=ae[t][e],c=M[n];s.dataset.color=c.dataset.color}async function A(){b(ie)||ce++,ue&&i(ie,!1),fe&&l(ie,!1),ie=T(ie);const e=P.querySelector("span.color-text"),t=k[ie].cloneNode(!0);e.replaceWith(t),b(ie)&&(await A(),await C())}function b(e=ie){return me&&!Z.AI_LIST.includes(e)}function T(e=ie,t=ne){return(e+t)%t+1}function S(e,t){if(!h(e,t))return!1;const n=w(e,t);let s=`len: ${n}`;Q.textContent+=`${s}\n`;const c=e=>e>=Z.WIN_LENGTH;let o=n.some(c),r=!o&&!p(T(ie));if(!o&&!r)return!1;let a="";J.emptyChild(),o&&(a+=`${ee[ie]} won.`,J.appendChild(k[ie].cloneNode(!0)),J.appendChild(document.createTextNode(" won."))),r&&(a+="draw.",J.appendChild(document.createTextNode("draw."))),P.classList.replace("shown","hidden"),F.classList.replace("hidden","shown"),J.classList.replace("hidden","shown"),ue&&i(ie,!1),fe&&l(!1),l(ie,!0,Z.WIN_LENGTH),Y.disabled=!0,j.disabled=!0;const d="This game was over.";return F.textContent=d,s=x.dedent(`\n        result: ${a}\n        record: ${Ee}\n        ${d}\n    `),Q.textContent+=`${s}\n`,Q.scroll(0,Q.scrollHeight),!0}function w(e,t,n=oe[t][e],s=!0){const c=Object.freeze([[1,0],[0,1],[1,1],[-1,1]]),o=s?oe:re,r=new Array(c.length).fill(0);if(!h(e,t))return r;if(oe[t][e]===te.NONE&&n===te.NONE)return r;const a=o[t][e];o[t][e]=n;for(const[n,[s,a]]of c.entries()){let c=0;for(const n of[-1,1]){const r=Math.trunc((n+1)/2),[i,l]=[n*s,n*a];let[d,u]=[e+r*i,t+r*l];for(;o[t][e]===o[u][d];)d+=i,u+=l,c++}r[n]=c}return o[t][e]=a,r}function _(e=Z.DELAY_MSEC){if(e<=0)return;if(!Le){const t=2;e*=t}const t=K.querySelector("progress#progress"),n=K.querySelector('label[for="progress"]'),s=K.querySelector('output[for="progress"]'),c=Number(t.max);let o=0,r=Math.trunc(100*o/c);n.textContent=Le&&!he?"AI thinking ...":"Please wait ...",t.value=`${o}`,t.textContent=`${r}%`,s.textContent=`${r}%`,K.classList.replace("hidden","shown");const a=e/c,i=4;let l=Math.max(a,i),d=Math.trunc(l/a);return new Promise(e=>{Ie=window.setInterval(()=>{o+=d,r=Math.trunc(100*o/c),t.value=`${o}`,t.textContent=`${r}%`,s.textContent=`${r}%`,o>=Number(t.max)&&(K.classList.replace("shown","hidden"),window.clearInterval(Ie),e())},l)})}async function C(){for(const e of Z.AI_LIST)await y()}async function y(){if(!Z.AI_LIST.includes(ie))return;if(pe)return;Le=!0,Y.disabled=!0,j.disabled=!0,await _(Z.DELAY_MSEC);const[e,t]=g(Z.AI_LEVEL);f(e,t,ie,!0),pe=S(e,t),pe||(F.emptyChild(),Le=!1,Y.disabled=!1,j.disabled=!1,await A())}function g(e){if(0===ce){const e=Math.trunc(Z.BOARD_WIDTH/2),t=Math.trunc(Z.BOARD_HEIGHT/2);return[e,t]}if(x.isBetween(ce,1,Z.COLOR_NUM-1)){let e=[];for(const[t,n]of L())if(!f(t,n))for(const[s,c]of x.range2IntAll(-1,1,-1,1)){if(0===c&&0===s)continue;const[o,r]=[t+c,n+s];f(o,r)&&e.push([o,r])}return e.random()}switch(e){case 0:return H();case 1:return N();case 2:return O();case 3:return v();case 4:return D();default:exit()}}function H(){for(const[e,t]of L())if(f(e,t))return[e,t]}function N(){let e=[];for(const[t,n]of L())f(t,n)&&e.push([t,n]);return e.random()}function O(){let e=1,t=[];for(const[n,s]of L()){if(re=window.structuredClone(oe),!f(n,s,ie,!0,!1))continue;const c=w(n,s,ie,!1).max();e<=c&&(e<c&&(t=[]),e=c,t.push([n,s]))}return t.random()}function v(){let e=Z.WIN_LENGTH+1,t=[];for(const[n,s]of L()){if(re=window.structuredClone(oe),!f(n,s,ie,!0,!1))continue;let c=0;for(const[e,t]of L()){const n=T(ie);if(!f(e,t,n,!1,!1))continue;const s=w(e,t,n,!1).max();c=Math.max(c,s)}e>=c&&(e>c&&(t=[]),e=c,t.push([n,s]))}let n=0,s=[];return re=window.structuredClone(oe),t.forEach(([e,t])=>{const c=w(e,t,ie,!1).max();n<=c&&(n<c&&(s=[]),n=c,s.push([e,t]))}),s.random()}function D(){let e=Z.WIN_LENGTH+1,t=[];for(const[n,s]of L()){if(re=window.structuredClone(oe),!f(n,s,ie,!0,!1))continue;let c=0;for(const[e,t]of L()){const n=T(ie);if(!f(e,t,n,!1,!1))continue;const s=w(e,t,n,!1).max();c=Math.max(c,s)}e>=c&&(e>c&&(t=[]),e=c,t.push([n,s]))}let n=0,s=[];return re=window.structuredClone(oe),t.forEach(([e,t])=>{const c=w(e,t,ie,!1).max();n<=c&&(n<c&&(s=[]),n=c,s.push([e,t]))}),s.random()}const x=await import("../library/library.min.js"),M=document.querySelectorAll("div#template-area > svg.cell"),R=document.querySelectorAll("div#template-area > svg.highlight"),q=document.querySelectorAll("div#template-area > svg.assist"),$=document.querySelectorAll("div#template-area > svg.hint"),k=document.querySelectorAll("div#template-area > span.color-text"),W=Object.freeze({COLOR_NUM:document.querySelector("select#COLOR_NUM"),WIN_LENGTH:document.querySelector("select#WIN_LENGTH"),BOARD_WIDTH:document.querySelector("input#BOARD_WIDTH"),BOARD_HEIGHT:document.querySelector("input#BOARD_HEIGHT"),AI_LIST:document.querySelectorAll("ul#AI_LIST input"),AI_LEVEL:document.querySelector("select#AI_LEVEL"),DELAY_MSEC:document.querySelector("select#DELAY_MSEC")}),B=document.querySelector("button#enter"),G=document.querySelector("button#default"),U=document.querySelector("button#slide"),V=document.querySelector("table#board"),Y=document.querySelector("button#assist"),j=document.querySelector("button#hint"),z=document.querySelector("button#reset"),P=document.querySelector("div#turn"),F=document.querySelector("div#message"),K=document.querySelector("div#wait"),J=document.querySelector("div#result"),Q=document.querySelector("div#log"),X=Object.freeze({COLOR_NUM:2,WIN_LENGTH:5,BOARD_WIDTH:8,BOARD_HEIGHT:8,AI_LIST:[],AI_LEVEL:2,DELAY_MSEC:500});let Z=window.structuredClone(X);const ee=Object.freeze([...k].map(e=>e.textContent.toUpperCase())),te=Object.freeze(x.createEnum(...ee));let ne=0,se=0,ce=0,oe=[],re=[],ae=[],ie=0,le=!1,de=!1,ue=!1,fe=!1,pe=!1,he=!1,Le=!1,me=!1,Ee="",Ie=0;e()});